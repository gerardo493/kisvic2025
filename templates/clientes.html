{% extends "base.html" %}

{% block title %}Gestión de Clientes{% endblock %}

{% block content %}
<style>
    .clientes-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .page-header {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        color: white;
    }

    .page-header h2 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .table-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    .search-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        padding: 1.5rem;
    }

    .search-card .input-group {
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        border-radius: 8px;
        overflow: hidden;
    }

    .search-card .input-group-text {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        color: white;
        border: none;
        padding: 0.75rem 1rem;
    }

    .search-card .form-control {
        border: 1px solid #e0e0e0;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        color: #1a237e;
    }

    .search-card .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(26, 35, 126, 0.25);
        border-color: #1a237e;
    }

    .search-card .form-select {
        border: 1px solid #e0e0e0;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        color: #1a237e;
        background-color: white;
        cursor: pointer;
    }

    .search-card .form-select:focus {
        box-shadow: 0 0 0 0.2rem rgba(26, 35, 126, 0.25);
        border-color: #1a237e;
    }

    .search-card .btn-primary {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        border: none;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .search-card .btn-primary:hover {
        background: linear-gradient(135deg, #0d47a1 0%, #1a237e 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .table th {
        background-color: #1a237e;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 1rem;
        letter-spacing: 0.5px;
        padding: 1rem;
    }

    .table td {
        font-size: 1.1rem;
        color: #1a237e;
        padding: 1rem;
        vertical-align: middle;
        font-weight: 500;
    }

    .cliente-info {
        max-width: 200px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 600;
        font-size: 1.1rem;
        color: #1a237e;
    }

    .cliente-info:hover {
        white-space: normal;
        overflow: visible;
    }

    .btn-action {
        padding: 0.25rem 0.5rem;
        margin: 0 0.1rem;
    }

    .contact-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-whatsapp {
        background-color: #25D366;
        color: white;
    }

    .btn-whatsapp:hover {
        background-color: #128C7E;
        color: white;
    }

    .btn-gmail {
        background-color: #EA4335;
        color: white;
    }

    .btn-gmail:hover {
        background-color: #D33426;
        color: white;
    }

    /* Estilos para autocompletado */
    .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        max-height: 300px;
        overflow-y: auto;
        display: none;
    }

    .autocomplete-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover {
        background-color: #f8f9fa;
        transform: translateX(4px);
    }

    .autocomplete-item.selected {
        background-color: #e3f2fd;
        border-left: 4px solid #1a237e;
    }

    .autocomplete-item .cliente-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 14px;
        flex-shrink: 0;
    }

    .autocomplete-item .cliente-info {
        flex: 1;
        min-width: 0;
    }

    .autocomplete-item .cliente-nombre {
        font-weight: 600;
        color: #1a237e;
        font-size: 14px;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .autocomplete-item .cliente-details {
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .autocomplete-item .cliente-rif {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
    }

    .autocomplete-item .cliente-contacto {
        color: #666;
    }

    .autocomplete-item .highlight {
        background-color: #fff3cd;
        padding: 1px 2px;
        border-radius: 2px;
    }

    /* Scrollbar personalizado para el dropdown */
    .autocomplete-dropdown::-webkit-scrollbar {
        width: 6px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .autocomplete-dropdown::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Loading indicator */
    .autocomplete-loading {
        padding: 16px;
        text-align: center;
        color: #666;
        font-style: italic;
    }

    .autocomplete-loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* No results */
    .autocomplete-no-results {
        padding: 16px;
        text-align: center;
        color: #666;
        font-style: italic;
    }

    .fa-gmail:before {
        content: "G";
        font-family: Arial, sans-serif;
        font-weight: bold;
    }

    .badge {
        font-size: 1rem;
        padding: 0.6em 1em;
        font-weight: 600;
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .text-muted {
        font-size: 1rem;
        color: #1a237e !important;
        font-weight: 500;
    }

    .text-muted i {
        margin-right: 5px;
        color: #1a237e;
    }

    .btn-sm {
        font-size: 1rem;
        padding: 0.4rem 0.6rem;
    }

    @media (max-width: 768px) {
        .page-header {
            padding: 1.5rem;
        }
        .table-responsive {
            font-size: 1rem;
        }
        .btn-action {
            padding: 0.2rem 0.4rem;
        }
        .cliente-info {
            font-size: 1rem;
        }
    }
</style>

<div class="clientes-container">
    <div class="container-fluid">
        <div class="page-header d-flex justify-content-between align-items-center">
            <h2><i class="fas fa-users me-2"></i>Gestión de Clientes</h2>
            <div class="btn-group">
                <a href="{{ url_for('mapa_avanzado') }}" class="btn btn-info">
                    <i class="fas fa-map-marked-alt me-2"></i>Mapa Avanzado
                </a>
                <a href="{{ url_for('reporte_clientes') }}" class="btn btn-success">
                    <i class="fas fa-chart-bar me-2"></i>Ver Reporte
                </a>
                <a href="{{ url_for('nuevo_cliente') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Nuevo Cliente
                </a>
            </div>
        </div>

        <div class="search-card">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-6">
                        <div class="input-group position-relative">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control" name="q" id="searchInput"
                                   placeholder="Buscar por nombre o RIF del cliente..." value="{{ q or '' }}"
                                   autocomplete="off">
                            <div id="autocompleteResults" class="autocomplete-dropdown"></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select name="orden" class="form-select">
                            <option value="nombre" {% if filtro_orden == 'nombre' %}selected{% endif %}>
                                <i class="fas fa-sort-alpha-down"></i> Ordenar por Nombre
                            </option>
                            <option value="rif" {% if filtro_orden == 'rif' %}selected{% endif %}>
                                <i class="fas fa-sort-numeric-down"></i> Ordenar por RIF
                            </option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter me-2"></i>Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>RIF</th>
                                <th>Nombre</th>
                                <th>Contacto</th>
                                <th>Dirección</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for id, cliente in clientes.items() %}
                            <tr>
                                <td>
                                    <span class="badge bg-secondary">{{ id }}</span>
                                </td>
                                <td>
                                    <div class="cliente-info" title="{{ cliente.nombre }}">
                                        {{ cliente.nombre }}
                                    </div>
                                </td>
                                <td>
                                    <div class="contact-buttons">
                                        {% if cliente.telefono %}
                                        <a href="https://wa.me/{{ cliente.telefono }}" target="_blank" 
                                           class="btn btn-whatsapp btn-sm" title="Enviar WhatsApp">
                                            <i class="fab fa-whatsapp"></i>
                                        </a>
                                        {% endif %}
                                        {% if cliente.email %}
                                        <a href="mailto:{{ cliente.email }}" class="btn btn-gmail btn-sm" title="Enviar Email">
                                            <i class="fas fa-envelope"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        {% if cliente.telefono %}
                                        <i class="fab fa-whatsapp"></i> {{ cliente.telefono }}<br>
                                        {% endif %}
                                        {% if cliente.email %}
                                        <i class="fas fa-envelope"></i> {{ cliente.email }}
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div class="cliente-info" title="{{ cliente.direccion }}">
                                        {{ cliente.direccion }}
                                    </div>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{{ url_for('historial_cliente', id=id) }}" 
                                           class="btn btn-info btn-action" title="Ver historial">
                                            <i class="fas fa-history"></i>
                                        </a>
                                        <a href="{{ url_for('editar_cliente', id=id) }}" 
                                           class="btn btn-warning btn-action" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-danger btn-action" title="Eliminar"
                                                onclick="confirmarEliminacion('{{ id }}', '{{ cliente.nombre }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="modalEliminar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro que desea eliminar al cliente <strong id="nombreCliente"></strong>?</p>
                <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formEliminar" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Eliminar Cliente
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<footer class="footer mt-auto py-3 bg-light text-center">
</footer>

{% endblock %}

{% block extra_js %}
<script>
function confirmarEliminacion(id, nombre) {
    document.getElementById('nombreCliente').textContent = nombre;
    document.getElementById('formEliminar').action = `/clientes/${id}/eliminar`;
    new bootstrap.Modal(document.getElementById('modalEliminar')).show();
}

// Sistema de autocompletado avanzado
class ClienteAutocomplete {
    constructor() {
        this.searchInput = document.getElementById('searchInput');
        this.resultsContainer = document.getElementById('autocompleteResults');
        this.selectedIndex = -1;
        this.results = [];
        this.debounceTimer = null;
        this.isLoading = false;
        
        this.init();
    }
    
    init() {
        if (!this.searchInput || !this.resultsContainer) {
            console.error('No se encontraron los elementos necesarios para el autocompletado');
            return;
        }
        
        // Event listeners
        this.searchInput.addEventListener('input', (e) => this.handleInput(e));
        this.searchInput.addEventListener('keydown', (e) => this.handleKeydown(e));
        this.searchInput.addEventListener('focus', () => this.showResults());
        this.searchInput.addEventListener('blur', () => this.hideResults());
        
        // Cerrar al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (!this.searchInput.contains(e.target) && !this.resultsContainer.contains(e.target)) {
                this.hideResults();
            }
        });
    }
    
    handleInput(e) {
        const query = e.target.value.trim();
        
        // Limpiar timer anterior
        if (this.debounceTimer) {
            clearTimeout(this.debounceTimer);
        }
        
        // Si la query está vacía, ocultar resultados
        if (query.length === 0) {
            this.hideResults();
            return;
        }
        
        // Debounce para evitar muchas peticiones
        this.debounceTimer = setTimeout(() => {
            this.searchClientes(query);
        }, 300);
    }
    
    async searchClientes(query) {
        if (this.isLoading) return;
        
        this.isLoading = true;
        this.showLoading();
        
        try {
            const url = `/api/clientes/autocomplete?q=${encodeURIComponent(query)}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            this.results = data;
            this.renderResults();
        } catch (error) {
            console.error('Error en búsqueda:', error);
            this.showError();
        } finally {
            this.isLoading = false;
        }
    }
    
    renderResults() {
        if (this.results.length === 0) {
            this.showNoResults();
            return;
        }
        
        this.resultsContainer.innerHTML = '';
        this.selectedIndex = -1;
        
        this.results.forEach((cliente, index) => {
            const item = this.createResultItem(cliente, index);
            this.resultsContainer.appendChild(item);
        });
        
        this.showResults();
    }
    
    createResultItem(cliente, index) {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        item.dataset.index = index;
        
        // Crear avatar con iniciales
        const iniciales = this.getIniciales(cliente.nombre);
        
        // Resaltar texto de búsqueda
        const nombreHighlighted = this.highlightText(cliente.nombre, this.searchInput.value);
        const rifHighlighted = this.highlightText(cliente.rif, this.searchInput.value);
        
        item.innerHTML = `
            <div class="cliente-avatar">${iniciales}</div>
            <div class="cliente-info">
                <div class="cliente-nombre">${nombreHighlighted}</div>
                <div class="cliente-details">
                    <span class="cliente-rif">${rifHighlighted}</span>
                    ${cliente.email ? `<span class="cliente-contacto"><i class="fas fa-envelope"></i> ${cliente.email}</span>` : ''}
                    ${cliente.telefono ? `<span class="cliente-contacto"><i class="fas fa-phone"></i> ${cliente.telefono}</span>` : ''}
                </div>
            </div>
        `;
        
        // Event listeners
        item.addEventListener('click', () => this.selectCliente(cliente));
        item.addEventListener('mouseenter', () => this.highlightItem(index));
        
        return item;
    }
    
    getIniciales(nombre) {
        return nombre
            .split(' ')
            .map(word => word.charAt(0))
            .join('')
            .toUpperCase()
            .substring(0, 2);
    }
    
    highlightText(text, query) {
        if (!query) return text;
        
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<span class="highlight">$1</span>');
    }
    
    selectCliente(cliente) {
        this.searchInput.value = cliente.nombre;
        this.hideResults();
        
        // Enviar el formulario automáticamente
        this.searchInput.form.submit();
    }
    
    handleKeydown(e) {
        const items = this.resultsContainer.querySelectorAll('.autocomplete-item');
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
                this.updateSelection(items);
                break;
                
            case 'ArrowUp':
                e.preventDefault();
                this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                this.updateSelection(items);
                break;
                
            case 'Enter':
                e.preventDefault();
                if (this.selectedIndex >= 0 && this.results[this.selectedIndex]) {
                    this.selectCliente(this.results[this.selectedIndex]);
                } else {
                    this.searchInput.form.submit();
                }
                break;
                
            case 'Escape':
                this.hideResults();
                this.searchInput.blur();
                break;
        }
    }
    
    updateSelection(items) {
        items.forEach((item, index) => {
            item.classList.toggle('selected', index === this.selectedIndex);
        });
    }
    
    highlightItem(index) {
        this.selectedIndex = index;
        const items = this.resultsContainer.querySelectorAll('.autocomplete-item');
        this.updateSelection(items);
    }
    
    showResults() {
        if (this.results.length > 0 || this.isLoading) {
            this.resultsContainer.style.display = 'block';
        }
    }
    
    hideResults() {
        this.resultsContainer.style.display = 'none';
    }
    
    showLoading() {
        this.resultsContainer.innerHTML = `
            <div class="autocomplete-loading">
                <i class="fas fa-spinner"></i> Buscando clientes...
            </div>
        `;
        this.showResults();
    }
    
    showNoResults() {
        this.resultsContainer.innerHTML = `
            <div class="autocomplete-no-results">
                <i class="fas fa-search"></i> No se encontraron clientes
            </div>
        `;
        this.showResults();
    }
    
    showError() {
        this.resultsContainer.innerHTML = `
            <div class="autocomplete-no-results">
                <i class="fas fa-exclamation-triangle"></i> Error en la búsqueda
            </div>
        `;
        this.showResults();
    }
}

// Inicializar autocompletado cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    new ClienteAutocomplete();
});
</script>
{% endblock %}