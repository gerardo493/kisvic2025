{% extends "base.html" %}

{% block title %}Pagos Recibidos{% endblock %}

{% block content %}
<style>
    .pagos-header {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem 2rem 1rem 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .pagos-header h2 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
    }
    .pagos-header i {
        font-size: 2.2rem;
        margin-right: 1rem;
    }
    .stats-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: none;
        margin-bottom: 2rem;
        transition: all 0.3s ease;
        overflow: hidden;
    }
    .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .stats-card .card-body {
        padding: 1.5rem;
    }
    .stats-card .stats-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .stats-card .stats-label {
        font-size: 1.1rem;
        font-weight: 600;
        opacity: 0.9;
    }
    .table thead th {
        background: #f8f9fa;
        font-weight: 700;
        color: #1a237e;
        border-top: none;
    }
    .table tbody tr {
        transition: all 0.2s;
    }
    .table tbody tr:hover {
        background: #e3f2fd;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(13,71,161,0.07);
    }
    .btn-action {
        padding: 0.4rem 0.7rem;
        font-size: 1rem;
        border-radius: 8px;
        margin-right: 0.2rem;
    }
    .floating-calc-btn {
        position: fixed;
        bottom: 32px;
        right: 32px;
        z-index: 1200;
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 64px;
        height: 64px;
        box-shadow: 0 4px 16px rgba(67,233,123,0.18);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        transition: box-shadow 0.2s, transform 0.2s;
    }
    .floating-calc-btn:hover {
        box-shadow: 0 8px 32px rgba(67,233,123,0.28);
        transform: scale(1.08);
        color: #fff;
    }
    .modal-calc .modal-content {
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(67,233,123,0.18);
    }
    .modal-calc .modal-header {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: #fff;
        border-radius: 18px 18px 0 0;
    }
    .modal-calc .form-label {
        font-weight: 600;
    }
    .modal-calc .alert-info {
        background: #e3fcec;
        color: #1a3c34;
        border: none;
    }
    /* Tabla moderna */
    .table-modern thead th {
        background: #1a237e;
        color: #fff;
        position: sticky;
        top: 0;
        z-index: 2;
        border-top: none;
        cursor: default;
    }
    .table-modern tbody tr:nth-child(even) {
        background: #f4f8fb;
    }
    .table-modern tbody tr:hover {
        background: #e3f2fd;
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(13,71,161,0.07);
    }
    .badge-metodo {
        font-size: 0.95em;
        border-radius: 8px;
        padding: 0.3em 0.8em;
        font-weight: 600;
    }
    .badge-transferencia { background: #e1bee7; color: #6a1b9a; }
    .badge-efectivo { background: #ffe082; color: #bfa43a; }
    .badge-zelle { background: #b2dfdb; color: #00695c; }
    .badge-pago_movil { background: #bbdefb; color: #1565c0; }
    .badge-divisas { background: #c8e6c9; color: #388e3c; }
    .badge-otro { background: #f8bbd0; color: #ad1457; }
    .btn-action {
        padding: 0.4rem 0.7rem;
        font-size: 1rem;
        border-radius: 8px;
        margin-right: 0.2rem;
    }

    /* Alineación numérica y anchos por columna */
    .col-factura { width: 10rem; }
    .col-fecha { width: 9.5rem; }
    .col-cliente { min-width: 16rem; }
    .col-metodo { width: 8.5rem; }
    .col-monto { width: 9rem; }
    .numeric { text-align: right; font-variant-numeric: tabular-nums; white-space: nowrap; }
    .hidden-col { display: none !important; }

    /* Barra de herramientas de tabla */
    .table-tools { display:flex; gap:.5rem; align-items:center; flex-wrap: wrap; margin-bottom:.75rem; }
    .table-tools .form-control, .table-tools .form-select { height: 36px; }
    .table-tools .btn { height: 36px; }

    /* Encabezados ordenables */
    th.sortable { cursor: pointer; user-select: none; position: relative; }
    th.sortable::after {
        content: '\25B4\25BE'; /* ▲▼ */
        font-size: .7rem; opacity: .6; margin-left: .35rem;
    }
    th.sortable.asc::after { content: '\25B4'; opacity: 1; }
    th.sortable.desc::after { content: '\25BE'; opacity: 1; }

    /* Validador Pago Móvil */
    .validator-hint { font-size: .9rem; }
    .is-valid-pm { border-color: #28a745 !important; }
    .is-invalid-pm { border-color: #dc3545 !important; }

    /* Estilos de impresión: simplificar y optimizar lectura */
    @media print {
        .pagos-header, .floating-calc-btn, .table-tools, .btn, .card-header, nav, header, footer { display: none !important; }
        .card, .card-body { box-shadow: none !important; border: none !important; }
        .table-modern thead th { position: static; background: #f0f3f7 !important; color: #111 !important; }
        .table-modern tbody tr:hover { background: transparent; transform: none; box-shadow: none; }
        .table td, .table th { padding: 6px 8px !important; font-size: 11pt; }
        .numeric { font-size: 10.8pt; }
        .badge { border: 1px solid #999; }
        .table-modern { page-break-inside: auto; }
        .table-modern tr { page-break-inside: avoid; page-break-after: auto; }
        .table-modern thead { display: table-header-group; }
        .table-modern tfoot { display: table-footer-group; }
    }
</style>
<div class="container-fluid">
    <div class="pagos-header mb-4">
        <h2><i class="fas fa-cash-register"></i> Pagos Recibidos</h2>
        <div class="btn-group">
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
            </a>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stats-card shadow-lg" style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); border: none;">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-dollar-sign fa-2x me-3 text-success"></i>
                    <div>
                        <div class="stats-value text-success" style="font-size:2.1rem;">${{ total_usd|float|es_number }}</div>
                        <div class="stats-label">Total Pagos Recibidos (USD)</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card shadow-lg" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: none;">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-money-bill-wave fa-2x me-3 text-info"></i>
                    <div>
                        <div class="stats-value text-info" style="font-size:2.1rem;">{{ total_bs|float|es_number }} Bs</div>
                        <div class="stats-label">Total Pagos Recibidos (Bs)</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card shadow-lg" style="background: linear-gradient(135deg, #fffde7 0%, #ffe082 100%); border: none;">
                <div class="card-body d-flex align-items-center">
                    <i class="fas fa-chart-line fa-2x me-3 text-warning"></i>
                    <div style="width:100%">
                        <!-- Carrusel de tasas -->
                        <div id="tasasCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
                          <div class="carousel-inner">
                            <div class="carousel-item active">
                              <div class="stats-value text-secondary" style="font-size:2.1rem;">
                                <span id="tasa-bcv-valor">{{ tasa_bcv|default('Cargando...', true)|es_number }}</span> <span class="badge bg-warning text-dark">BCV</span>
                              </div>
                            </div>
                            <div class="carousel-item">
                              <div class="stats-value text-secondary" style="font-size:2.1rem;">
                                <span id="tasa-eur-valor">{{ tasa_bcv_eur|default('Cargando...', true)|es_number }}</span> <span class="badge bg-primary">Euro</span>
                              </div>
                            </div>
                          </div>
                        </div>
                        <small class="d-block text-muted" style="font-size:0.8rem;" id="ultima-actualizacion">
                            <i class="fas fa-sync-alt fa-spin"></i> Actualizando...
                        </small>
                        <div class="stats-label">Tasa BCV Actual</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-3">
      <div class="col-auto">
        <form method="get" class="d-flex align-items-center gap-2">
          <label for="mes" class="form-label" style="color:#1a237e;font-weight:700;">Mes:</label>
          <select name="mes" id="mes" class="form-select form-select-sm" style="width:auto;" onchange="this.form.submit()">
            <option value="">Todos</option>
            {% for m in range(1, 13) %}
              <option value="{{ m }}" {% if mes_seleccionado == m %}selected{% endif %}>{{ '{:02d}'.format(m) }}</option>
            {% endfor %}
          </select>
          <label for="anio" class="form-label" style="color:#1a237e;font-weight:700;">Año:</label>
          <select name="anio" id="anio" class="form-select form-select-sm" style="width:auto;" onchange="this.form.submit()">
            <option value="">Todos</option>
            {% for a in anios_disponibles %}
              <option value="{{ a }}" {% if anio_seleccionado == a %}selected{% endif %}>{{ a }}</option>
            {% endfor %}
          </select>
        </form>
      </div>
    </div>
    <!-- Botón flotante para calculadora -->
    <button class="floating-calc-btn" id="openCalcModal" title="Calculadora de Montos">
        <i class="fas fa-calculator"></i>
    </button>
    <!-- Validador de Pago Móvil -->
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center justify-content-between">
            <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>Validador de Pago Móvil (Venezuela)</h5>
            <small class="text-muted">Ingresa los datos tal como te los reporta el comprobante</small>
        </div>
        <div class="card-body">
            <form id="pmForm" class="row g-2 align-items-end">
                <div class="col-12 col-md-2">
                    <label class="form-label">Banco Emisor</label>
                    <input type="text" class="form-control" id="pmBanco" placeholder="Ej: BOD"/>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Teléfono</label>
                    <input type="tel" class="form-control" id="pmTelefono" placeholder="0412XXXXXXX"/>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">CI/RIF</label>
                    <input type="text" class="form-control" id="pmCedula" placeholder="V12345678"/>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Monto (Bs)</label>
                    <input type="number" step="any" min="0" class="form-control" id="pmMonto" placeholder="0,00"/>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Referencia</label>
                    <input type="text" class="form-control" id="pmReferencia" placeholder="8-12 dígitos"/>
                </div>
                <div class="col-6 col-md-2">
                    <label class="form-label">Fecha/Hora</label>
                    <input type="datetime-local" class="form-control" id="pmFecha"/>
                </div>
                <div class="col-12">
                    <button type="button" id="validarPM" class="btn btn-success"><i class="fas fa-check-circle me-1"></i>Validar</button>
                    <span id="pmResultado" class="ms-2 validator-hint"></span>
                </div>
            </form>
        </div>
    </div>
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0">Detalle de Pagos Recibidos</h4>
        </div>
        <div class="card-body">
            <div class="table-tools">
                <div class="input-group" style="max-width: 320px;">
                  <span class="input-group-text"><i class="fas fa-search"></i></span>
                  <input id="filtroTexto" type="text" class="form-control" placeholder="Buscar factura, cliente, referencia...">
                </div>
                <select id="filtroMetodo" class="form-select" style="width: 180px;">
                    <option value="">Todos los métodos</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="zelle">Zelle</option>
                    <option value="pago_movil">Pago Movil</option>
                    <option value="divisas">Divisas</option>
                    <option value="otro">Otro</option>
                </select>
                <div class="input-group" style="max-width: 380px;">
                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                    <input type="date" id="fechaDesde" class="form-control" title="Desde">
                    <input type="date" id="fechaHasta" class="form-control" title="Hasta">
                </div>
                <button id="exportCsv" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-file-csv me-1"></i>Exportar CSV (filtrado)
                </button>
                <button id="limpiarFiltros" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-eraser me-1"></i>Limpiar
                </button>
                <button id="imprimirListado" class="btn btn-outline-dark btn-sm">
                    <i class="fas fa-print me-1"></i>Imprimir
                </button>
                <div class="input-group" style="max-width: 260px;">
                    <span class="input-group-text"><i class="fas fa-list-ol"></i></span>
                    <select id="pageSize" class="form-select">
                        <option value="10">10 por página</option>
                        <option value="25">25 por página</option>
                        <option value="50">50 por página</option>
                        <option value="100">100 por página</option>
                        <option value="0">Todos</option>
                    </select>
                </div>
                <div id="paginacion" class="d-flex align-items-center gap-2">
                    <button id="prevPage" class="btn btn-outline-secondary btn-sm"><i class="fas fa-chevron-left"></i></button>
                    <span id="pageInfo" class="small text-muted">1 / 1</span>
                    <button id="nextPage" class="btn btn-outline-secondary btn-sm"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="small text-muted">Columnas:</span>
                    <label class="form-check form-check-inline m-0">
                        <input class="form-check-input col-toggle" type="checkbox" data-col="metodo" checked>
                        <span class="form-check-label small">Método</span>
                    </label>
                    <label class="form-check form-check-inline m-0">
                        <input class="form-check-input col-toggle" type="checkbox" data-col="usd" checked>
                        <span class="form-check-label small">USD</span>
                    </label>
                    <label class="form-check form-check-inline m-0">
                        <input class="form-check-input col-toggle" type="checkbox" data-col="bs" checked>
                        <span class="form-check-label small">Bs</span>
                    </label>
                    <label class="form-check form-check-inline m-0">
                        <input class="form-check-input col-toggle" type="checkbox" data-col="acciones" checked>
                        <span class="form-check-label small">Acciones</span>
                    </label>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle table-modern" id="tablaPagos">
                    <thead>
                        <tr>
                            <th class="col-factura sortable" data-key="factura" title="Ordenar">Factura</th>
                            <th class="col-fecha sortable" data-key="fecha" title="Ordenar">Fecha</th>
                            <th class="col-cliente sortable" data-key="cliente" title="Ordenar">Cliente</th>
                            <th class="col-metodo sortable" data-key="metodo" title="Ordenar">Método</th>
                            <th class="col-monto col-usd text-end sortable" data-key="usd" title="Ordenar">Monto (USD)</th>
                            <th class="col-monto col-bs text-end sortable" data-key="bs" title="Ordenar">Monto (Bs)</th>
                            <th class="col-acciones">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set tot = namespace(usd=0.0, bs=0.0) %}
                        {% for pago in pagos %}
                        {% set usd_val = pago.monto|float %}
                        {% set bs_val = (pago.monto|float * pago.tasa_bcv)|float %}
                        {% set tot.usd = tot.usd + usd_val %}
                        {% set tot.bs = tot.bs + bs_val %}
                        <tr data-metodo="{{ pago.metodo|replace(' ', '_')|lower }}"
                            data-factura="{{ pago.factura_id }}"
                            data-fecha="{{ pago.fecha }}"
                            data-cliente="{{ (clientes[pago.cliente_id].nombre if pago.cliente_id in clientes else pago.cliente_id)|lower }}"
                            data-referencia="{{ pago.referencia if pago.referencia is defined and pago.referencia else '' }}"
                            data-usd="{{ '%.2f' % usd_val }}"
                            data-bs="{{ '%.2f' % bs_val }}">
                            <td class="col-factura"><a href="/facturas/{{ pago.factura_id }}">#{{ pago.factura_id }}</a></td>
                            <td class="col-fecha">{{ pago.fecha }}</td>
                            <td class="col-cliente">
                                {% if pago.cliente_id in clientes %}
                                    <a href="/clientes/{{ pago.cliente_id }}">{{ clientes[pago.cliente_id].nombre }}</a>
                                {% else %}
                                    {{ pago.cliente_id }}
                                {% endif %}
                            </td>
                            <td class="col-metodo">
                                <span class="badge badge-metodo badge-{{ pago.metodo|replace(' ', '_')|lower }}">
                                    {{ pago.metodo.replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td class="numeric col-usd">$ {{ usd_val|es_number }}</td>
                            <td class="numeric col-bs">{{ bs_val|es_number }} Bs</td>
                            <td class="col-acciones">
                                <button class="btn btn-info btn-action" data-bs-toggle="modal" data-bs-target="#modalDetallePago" 
                                    data-factura="{{ pago.factura_id }}" data-fecha="{{ pago.fecha }}" data-monto="{{ pago.monto }}" 
                                    data-metodo="{{ pago.metodo }}" 
                                    data-referencia="{{ pago.referencia if pago.referencia is defined and pago.referencia else '-' }}" 
                                    data-banco="{{ pago.banco if pago.banco is defined and pago.banco else '-' }}" 
                                    data-captura="{{ pago.captura_path|default('') }}" title="Ver Detalle">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if pagos|length == 0 %}
                        <tr>
                            <td colspan="7">No hay pagos registrados.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <th colspan="4" class="text-end">Total listado:</th>
                            <th class="numeric col-usd" id="totalListadoUSD">$ {{ tot.usd|es_number }}</th>
                            <th class="numeric col-bs" id="totalListadoBS">{{ tot.bs|es_number }} Bs</th>
                            <th></th>
                        </tr>
                        <tr>
                            <td colspan="7">
                                <div id="resumenMetodos" class="d-flex flex-wrap gap-2 small text-muted"></div>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalle de Pago -->
<div class="modal fade" id="modalDetallePago" tabindex="-1" aria-labelledby="modalDetallePagoLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalDetallePagoLabel">Detalle del Pago</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Factura:</strong> <span id="detalle-factura"></span></li>
          <li class="list-group-item"><strong>Fecha:</strong> <span id="detalle-fecha"></span></li>
          <li class="list-group-item"><strong>Monto:</strong> $<span id="detalle-monto"></span></li>
          <li class="list-group-item"><strong>Método:</strong> <span id="detalle-metodo"></span></li>
          <li class="list-group-item"><strong>Referencia:</strong> <span id="detalle-referencia"></span></li>
          <li class="list-group-item"><strong>Banco:</strong> <span id="detalle-banco"></span></li>
          <li class="list-group-item" id="detalle-captura-li">
            <strong>Captura:</strong>
            <div class="mt-2" id="detalle-captura-content">
              <!-- Aquí se mostrará la imagen o el mensaje -->
            </div>
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Calculadora -->
<div class="modal fade modal-calc" id="modalCalc" tabindex="-1" aria-labelledby="modalCalcLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalCalcLabel"><i class="fas fa-calculator me-2"></i>Calculadora de Montos y Conversión</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="calcForm">
          <div class="row g-2 align-items-end">
            <div class="col-6">
              <label class="form-label">Monto</label>
              <input type="number" step="any" min="0" class="form-control" id="calcMonto" value="1">
            </div>
            <div class="col-6">
              <label class="form-label">Moneda</label>
              <select class="form-select" id="calcMoneda">
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="BS">Bs</option>
              </select>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-6">
              <label class="form-label">Tasa BCV USD</label>
              <input type="number" step="any" min="0" class="form-control" id="calcTasaBCV" value="{{ tasa_bcv|float|es_number }}">
            </div>
            <div class="col-6">
              <label class="form-label">Tasa BCV EUR</label>
              <input type="number" step="any" min="0" class="form-control" id="calcTasaBCVEUR" value="{{ tasa_bcv_eur|default(0)|float|es_number }}">
            </div>
          </div>
          <div class="row g-2 mt-3">
            <div class="col-12">
              <div class="alert alert-info mb-2 p-2" id="calcResultados" style="font-size:1.1rem;"></div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Función para actualizar las tasas
function actualizarTasas() {
    // Mostrar indicador de actualización
    const ultimaActualizacion = document.getElementById('ultima-actualizacion');
    ultimaActualizacion.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Actualizando...';
    
    fetch('/api/tasas-actualizadas')
        .then(r => {
            if (!r.ok) {
                throw new Error(`Error HTTP: ${r.status}`);
            }
            return r.json();
        })
        .then(data => {
            if (!data || typeof data !== 'object') {
                throw new Error('Respuesta inválida del servidor');
            }

            // Validar que las tasas son números válidos
            const tasa_bcv = parseFloat(data.tasa_bcv);
            const tasa_bcv_eur = parseFloat(data.tasa_bcv_eur);

            if (isNaN(tasa_bcv) || isNaN(tasa_bcv_eur)) {
                throw new Error('Tasas inválidas en la respuesta');
            }

            // Actualizar los campos de tasa en el modal
            document.getElementById('calcTasaBCV').value = tasa_bcv.toFixed(2);
            document.getElementById('calcTasaBCVEUR').value = tasa_bcv_eur.toFixed(2);
            
            // Actualizar la tarjeta de tasas (carrusel)
            const tasaBCVElement = document.getElementById('tasa-bcv-valor');
            if (tasaBCVElement) {
                tasaBCVElement.textContent = tasa_bcv.toFixed(2);
            }
            const tasaEURElement = document.getElementById('tasa-eur-valor');
            if (tasaEURElement) {
                tasaEURElement.textContent = tasa_bcv_eur.toFixed(2);
            }
            
            // Actualizar la calculadora si está abierta
            actualizarCalculadora();
            
            // Mostrar mensaje de éxito con la fecha
            const fecha = new Date(data.fecha_actualizacion).toLocaleString();
            ultimaActualizacion.innerHTML = `<i class="fas fa-check-circle text-success"></i> Actualizado: ${fecha}`;
            
            // Cambiar el ícono después de 3 segundos
            setTimeout(() => {
                ultimaActualizacion.innerHTML = `<i class="fas fa-clock text-muted"></i> Última actualización: ${fecha}`;
            }, 3000);
        })
        .catch(error => {
            console.error('Error actualizando tasas:', error);
            ultimaActualizacion.innerHTML = `<i class="fas fa-exclamation-circle text-danger"></i> Error: ${error.message}`;
            
            // Intentar usar las tasas por defecto
            const tasaBCVElement = document.getElementById('tasa-bcv-valor');
            if (tasaBCVElement) {
                const tasaActual = parseFloat(tasaBCVElement.textContent);
                if (!isNaN(tasaActual)) {
                    document.getElementById('calcTasaBCV').value = tasaActual.toFixed(2);
                    document.getElementById('calcTasaBCVEUR').value = '0.00';
                    actualizarCalculadora();
                }
            }
        });
}

// Actualizar tasas al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    actualizarTasas();
    // Actualizar tasas cada 5 minutos
    setInterval(actualizarTasas, 5 * 60 * 1000);

    // Filtros rápidos y totales dinámicos
    const filtroTexto = document.getElementById('filtroTexto');
    const filtroMetodo = document.getElementById('filtroMetodo');
    const tabla = document.getElementById('tablaPagos');
    const cuerpo = tabla.querySelector('tbody');
    const totalUSD = document.getElementById('totalListadoUSD');
    const totalBS = document.getElementById('totalListadoBS');
    const resumenMetodos = document.getElementById('resumenMetodos');
    const fechaDesde = document.getElementById('fechaDesde');
    const fechaHasta = document.getElementById('fechaHasta');

    function normalizar(s){ return (s||'').toString().toLowerCase(); }

    function aplicarFiltros() {
        const t = normalizar(filtroTexto.value);
        const m = normalizar(filtroMetodo.value);
        const d = fechaDesde && fechaDesde.value ? new Date(fechaDesde.value) : null;
        const h = fechaHasta && fechaHasta.value ? new Date(fechaHasta.value) : null;
        let sumUSD = 0, sumBS = 0, visibles = 0;
        const conteoMetodos = {};

        cuerpo.querySelectorAll('tr').forEach(tr => {
            const matchTexto = !t || [
                tr.dataset.factura,
                tr.dataset.fecha,
                tr.dataset.cliente,
                tr.dataset.referencia
            ].some(v => normalizar(v).includes(t));
            const matchMetodo = !m || normalizar(tr.dataset.metodo) === m;
            // Validación de rango de fechas (suponiendo formato YYYY-MM-DD o similar)
            let matchFecha = true;
            if ((d || h) && tr.dataset.fecha) {
                try {
                    const f = new Date(tr.dataset.fecha);
                    if (d && f < d) matchFecha = false;
                    if (h && f > h) matchFecha = false;
                } catch(e) { matchFecha = true; }
            }

            const visible = matchTexto && matchMetodo && matchFecha;
            tr.style.display = visible ? '' : 'none';
            if (visible) {
                sumUSD += parseFloat(tr.dataset.usd || '0');
                sumBS += parseFloat(tr.dataset.bs || '0');
                visibles++;
                const key = normalizar(tr.dataset.metodo);
                conteoMetodos[key] = (conteoMetodos[key] || 0) + 1;
            }
        });
        if (totalUSD) totalUSD.textContent = `$ ${sumUSD.toLocaleString('es-ES', {minimumFractionDigits:2})}`;
        if (totalBS) totalBS.textContent = `${sumBS.toLocaleString('es-ES', {minimumFractionDigits:2})} Bs`;

        // Resumen por método
        if (resumenMetodos) {
            const badges = Object.entries(conteoMetodos).sort((a,b)=>b[1]-a[1]).map(([k,v]) => {
                const label = (k||'').replace('_',' ').toUpperCase() || 'N/A';
                return `<span class="badge rounded-pill bg-light text-dark border">${label}: ${v}</span>`;
            });
            resumenMetodos.innerHTML = badges.join('\n');
        }
    }

    if (filtroTexto) filtroTexto.addEventListener('input', aplicarFiltros);
    if (filtroMetodo) filtroMetodo.addEventListener('change', aplicarFiltros);
    if (fechaDesde) fechaDesde.addEventListener('change', aplicarFiltros);
    if (fechaHasta) fechaHasta.addEventListener('change', aplicarFiltros);

    // Exportación CSV del listado filtrado
    const exportBtn = document.getElementById('exportCsv');
    if (exportBtn) exportBtn.addEventListener('click', () => {
        const rows = [['Factura','Fecha','Cliente','Método','Monto USD','Monto Bs']];
        cuerpo.querySelectorAll('tr').forEach(tr => {
            if (tr.style.display === 'none') return;
            const tds = tr.querySelectorAll('td');
            rows.push([
                tds[0].innerText.trim(),
                tds[1].innerText.trim(),
                tds[2].innerText.trim(),
                tds[3].innerText.trim(),
                tds[4].innerText.replace('$','').trim(),
                tds[5].innerText.replace(' Bs','').trim()
            ]);
        });
        const csv = rows.map(r => r.map(v => '"'+v.replaceAll('"','""')+'"').join(',')).join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'pagos_filtrados.csv';
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);
        a.remove();
    });

    // Limpiar filtros
    const limpiar = document.getElementById('limpiarFiltros');
    if (limpiar) limpiar.addEventListener('click', () => {
        if (filtroTexto) filtroTexto.value = '';
        if (filtroMetodo) filtroMetodo.value = '';
        if (fechaDesde) fechaDesde.value = '';
        if (fechaHasta) fechaHasta.value = '';
        aplicarFiltros();
    });

    // Imprimir listado
    const btnImprimir = document.getElementById('imprimirListado');
    if (btnImprimir) btnImprimir.addEventListener('click', () => window.print());

    // Ordenamiento por columnas
    let orden = { key: null, dir: 1 };
    function comparar(a, b, key) {
        const va = a.dataset[key] || '';
        const vb = b.dataset[key] || '';
        if (key === 'usd' || key === 'bs') return (parseFloat(va) - parseFloat(vb)) * orden.dir;
        if (key === 'fecha') return (new Date(va) - new Date(vb)) * orden.dir;
        return va.localeCompare(vb) * orden.dir;
    }
    const ths = tabla.querySelectorAll('thead th.sortable');
    ths.forEach(th => th.addEventListener('click', () => {
        const key = th.dataset.key;
        const rows = Array.from(cuerpo.querySelectorAll('tr'));
        if (orden.key === key) { orden.dir *= -1; } else { orden.key = key; orden.dir = 1; }
        ths.forEach(t => t.classList.remove('asc','desc'));
        th.classList.add(orden.dir === 1 ? 'asc' : 'desc');
        rows.sort((a,b) => comparar(a,b,key)).forEach(tr => cuerpo.appendChild(tr));
        aplicarFiltros();
    }));

    // Paginación simple en cliente
    const pageSizeSel = document.getElementById('pageSize');
    const btnPrev = document.getElementById('prevPage');
    const btnNext = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    let pageSize = pageSizeSel ? parseInt(pageSizeSel.value, 10) : 0;
    let currentPage = 1;

    function paginasVisibles() {
        const visibles = Array.from(cuerpo.querySelectorAll('tr')).filter(tr => tr.style.display !== 'none');
        return visibles;
    }
    function renderPage() {
        const visibles = paginasVisibles();
        const total = visibles.length;
        if (!pageSize || pageSize <= 0) {
            visibles.forEach(tr => tr.style.display = '');
            if (pageInfo) pageInfo.textContent = `1 / 1`;
            return;
        }
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;
        visibles.forEach((tr, idx) => {
            const pageIdx = Math.floor(idx / pageSize) + 1;
            tr.style.display = pageIdx === currentPage ? '' : 'none';
        });
        if (pageInfo) pageInfo.textContent = `${currentPage} / ${totalPages}`;
    }
    function aplicarFiltrosYPaginar() {
        aplicarFiltros();
        currentPage = 1;
        renderPage();
    }
    if (pageSizeSel) pageSizeSel.addEventListener('change', () => {
        pageSize = parseInt(pageSizeSel.value, 10);
        currentPage = 1;
        renderPage();
    });
    if (btnPrev) btnPrev.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPage(); } });
    if (btnNext) btnNext.addEventListener('click', () => { currentPage++; renderPage(); });

    // Mostrar/ocultar columnas
    const toggles = document.querySelectorAll('.col-toggle');
    function setColVisibility(colKey, visible) {
        const cls = colKey === 'acciones' ? 'col-acciones' : (colKey === 'usd' ? 'col-usd' : (colKey === 'bs' ? 'col-bs' : `col-${colKey}`));
        document.querySelectorAll(`.${cls}`).forEach(el => el.classList.toggle('hidden-col', !visible));
    }
    toggles.forEach(t => t.addEventListener('change', () => setColVisibility(t.dataset.col, t.checked)));

    // Inicializar
    aplicarFiltrosYPaginar();

    // Validador de Pago Móvil (reglas básicas locales + heurísticas)
    const pm = {
        banco: document.getElementById('pmBanco'),
        tlf: document.getElementById('pmTelefono'),
        ci: document.getElementById('pmCedula'),
        monto: document.getElementById('pmMonto'),
        ref: document.getElementById('pmReferencia'),
        fecha: document.getElementById('pmFecha'),
        btn: document.getElementById('validarPM'),
        res: document.getElementById('pmResultado')
    };
    function normalizeNum(s){ return (s||'').toString().replace(/[^0-9]/g,''); }
    function isTelefono(v){ return /^0(412|414|416|426|424)[0-9]{7}$/.test(normalizeNum(v)); }
    function isCI(v){ return /^(V|E|J|G|P)[0-9]{5,12}$/i.test((v||'').toString().replace(/\s/g,'')); }
    function isMonto(v){ const n = parseFloat(v); return !isNaN(n) && n > 0; }
    function isReferencia(v){ return /^[0-9A-Za-z]{6,14}$/.test((v||'').toString().trim()); }
    function isFecha(v){ return !!v && !isNaN(new Date(v).getTime()); }
    function setValid(el, ok){ if (!el) return; el.classList.toggle('is-valid-pm', !!ok); el.classList.toggle('is-invalid-pm', !ok); }
    function validarTodo(){
        const okBanco = (pm.banco && pm.banco.value.trim().length >= 2);
        const okTlf = isTelefono(pm.tlf && pm.tlf.value);
        const okCI = isCI(pm.ci && pm.ci.value);
        const okMonto = isMonto(pm.monto && pm.monto.value);
        const okRef = isReferencia(pm.ref && pm.ref.value);
        const okFecha = isFecha(pm.fecha && pm.fecha.value);
        setValid(pm.banco, okBanco); setValid(pm.tlf, okTlf); setValid(pm.ci, okCI);
        setValid(pm.monto, okMonto); setValid(pm.ref, okRef); setValid(pm.fecha, okFecha);
        const ok = okBanco && okTlf && okCI && okMonto && okRef && okFecha;
        if (pm.res) pm.res.innerHTML = ok
            ? '<span class="text-success"><i class="fas fa-check-circle"></i> Formato válido. Verifica con el banco si es necesario.</span>'
            : '<span class="text-danger"><i class="fas fa-times-circle"></i> Datos incompletos o inválidos.</span>';
        return ok;
    }
    if (pm.btn) pm.btn.addEventListener('click', validarTodo);
    ['input','change'].forEach(evt => {
        [pm.banco, pm.tlf, pm.ci, pm.monto, pm.ref, pm.fecha].forEach(el => el && el.addEventListener(evt, validarTodo));
    });
});

// Modal de detalle de pago
var modalDetalle = document.getElementById('modalDetallePago');
modalDetalle.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    document.getElementById('detalle-factura').textContent = button.getAttribute('data-factura');
    document.getElementById('detalle-fecha').textContent = button.getAttribute('data-fecha');
    document.getElementById('detalle-monto').textContent = parseFloat(button.getAttribute('data-monto')).toLocaleString('es-ES', {minimumFractionDigits:2});
    document.getElementById('detalle-metodo').textContent = button.getAttribute('data-metodo').replace('_',' ').toUpperCase();
    document.getElementById('detalle-referencia').textContent = button.getAttribute('data-referencia') || '-';
    document.getElementById('detalle-banco').textContent = button.getAttribute('data-banco') || '-';
    
    var captura = button.getAttribute('data-captura');
    var capturaContent = document.getElementById('detalle-captura-content');
    if (captura && captura !== 'None' && captura !== '') {
        capturaContent.innerHTML = `
            <img src="/static/${captura}" alt="Captura de pago" class="img-fluid rounded" style="max-width: 100%;">
            <a href="/static/${captura}" target="_blank" class="btn btn-sm btn-primary mt-2">
                <i class="fas fa-external-link-alt"></i> Ver en tamaño completo
            </a>
        `;
    } else {
        capturaContent.innerHTML = '<span class="text-muted">No hay imagen de captura disponible para este pago.</span>';
    }
});

// Calculadora de Montos y Conversión
function actualizarCalculadora() {
    const monto = parseFloat(document.getElementById('calcMonto').value) || 0;
    const moneda = document.getElementById('calcMoneda').value;
    const tasaBCV = parseFloat(document.getElementById('calcTasaBCV').value.replace(',','.')) || 0;
    const tasaBCVEUR = parseFloat(document.getElementById('calcTasaBCVEUR').value.replace(',','.')) || 0;
    let usd = 0, eur = 0, bs = 0;
    if (moneda === 'USD') {
        usd = monto;
        bs = monto * tasaBCV;
        eur = tasaBCVEUR ? (bs / tasaBCVEUR) : 0;
    } else if (moneda === 'EUR') {
        eur = monto;
        bs = monto * tasaBCVEUR;
        usd = tasaBCV ? (bs / tasaBCV) : 0;
    } else if (moneda === 'BS') {
        bs = monto;
        usd = tasaBCV ? (monto / tasaBCV) : 0;
        eur = tasaBCVEUR ? (monto / tasaBCVEUR) : 0;
    }
    // Resultados
    let html = `<strong>USD:</strong> $${usd.toFixed(2)}<br>`;
    html += `<strong>EUR:</strong> €${eur.toFixed(2)}<br>`;
    html += `<strong>Bs (BCV):</strong> ${bs.toFixed(2)}`;
    document.getElementById('calcResultados').innerHTML = html;
}

document.getElementById('calcForm').addEventListener('input', actualizarCalculadora);

// Obtener tasas automáticamente al abrir el modal
const modalCalc = document.getElementById('modalCalc');
modalCalc.addEventListener('show.bs.modal', function () {
    actualizarTasas();
});

// Botón flotante abre el modal
const openCalcModal = document.getElementById('openCalcModal');
openCalcModal.addEventListener('click', function() {
    var modal = new bootstrap.Modal(document.getElementById('modalCalc'));
    modal.show();
});

// En el modal de la calculadora, agrega un pi animado junto al título
document.addEventListener('DOMContentLoaded', function() {
    const pi = document.createElement('span');
    pi.innerHTML = '<span style="font-size:1.5rem; color:#43e97b; margin-left:10px; animation: spinPi 2.5s linear infinite; display:inline-block;">&#960;</span>';
    const title = document.getElementById('modalCalcLabel');
    if (title) title.appendChild(pi);
});

// Animación para pi
const stylePi = document.createElement('style');
stylePi.innerHTML = `@keyframes spinPi { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }`;
document.head.appendChild(stylePi);
</script>
{% endblock %} 