{% extends "base.html" %}

{% block title %}Dashboard de Factura - {{ factura.numero }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header de la Factura -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="h3 mb-2 text-primary">
                                <i class="fas fa-file-invoice-dollar me-2"></i>
                                Factura {{ factura.numero }}
                            </h1>
                            <p class="text-muted mb-0">
                                <i class="fas fa-calendar me-1"></i>
                                {{ factura.fecha }} a las {{ factura.hora }}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex justify-content-end gap-2">
                                <a href="{{ url_for('imprimir_factura', id=factura._id) }}" 
                                   class="btn btn-primary" target="_blank">
                                    <i class="fas fa-print me-1"></i> Imprimir
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna Principal -->
        <div class="col-lg-8">
            <!-- Estado y Acciones R√°pidas -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title text-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>Estado de la Factura
                            </h5>
                            {% set saldo_pendiente = factura.get('saldo_pendiente', 0) %}
                            {% if saldo_pendiente > 0 %}
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge bg-warning fs-6 me-2">
                                        <i class="fas fa-clock me-1"></i>Pendiente
                                    </span>
                                    <span class="text-muted">Saldo: ${{ "%.2f"|format(saldo_pendiente) }}</span>
                                </div>
                            {% else %}
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge bg-success fs-6 me-2">
                                        <i class="fas fa-check-circle me-1"></i>Pagada
                                    </span>
                                </div>
                            {% endif %}
                            
                            <div class="progress mb-3" style="height: 8px;">
                                {% set total_factura = factura.get('total_usd', 0) %}
                                {% set total_abonado = factura.get('total_abonado', 0) %}
                                {% if total_factura > 0 %}
                                    {% set porcentaje = (total_abonado / total_factura * 100) | round %}
                                {% else %}
                                    {% set porcentaje = 0 %}
                                {% endif %}
                                <div class="progress-bar bg-success" style="width: {{ porcentaje }}%"></div>
                            </div>
                            <small class="text-muted">
                                {{ porcentaje }}% pagado (${{ "%.2f"|format(total_abonado) }} de ${{ "%.2f"|format(total_factura) }})
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title text-primary mb-3">
                                <i class="fas fa-bolt me-2"></i>Acciones R√°pidas
                            </h5>
                            <div class="d-grid gap-2">
                                {% if saldo_pendiente > 0 %}
                                    <button class="btn btn-success btn-sm" onclick="registrarPago()">
                                        <i class="fas fa-plus me-1"></i>Registrar Pago
                                    </button>
                                                                    <button class="btn btn-warning btn-sm" onclick="enviarRecordatorio()">
                                    <i class="fas fa-bell me-1"></i>Enviar Recordatorio
                                </button>
                                <button class="btn btn-info btn-sm" onclick="probarRecordatorio()">
                                    <i class="fas fa-bug me-1"></i>Probar Sistema
                                </button>
                                {% endif %}
                                <button class="btn btn-info btn-sm" onclick="duplicarFactura()">
                                    <i class="fas fa-copy me-1"></i>Duplicar Factura
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="enviarInformeFacturasPagadas()">
                                    <i class="fas fa-chart-line me-1"></i>Enviar Informe WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del Cliente -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-user me-2"></i>Informaci√≥n del Cliente
                    </h5>
                </div>
                <div class="card-body">
                    {% if factura.cliente_id in clientes %}
                        {% set cliente = clientes[factura.cliente_id] %}
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Nombre:</strong> {{ cliente.nombre }}</p>
                                <p><strong>RIF:</strong> {{ cliente.rif }}</p>
                                <p><strong>Tel√©fono:</strong> {{ cliente.telefono }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Direcci√≥n:</strong> {{ cliente.direccion }}</p>
                                <p><strong>Email:</strong> {{ cliente.email or 'No especificado' }}</p>
                                <p><strong>Estado:</strong> 
                                    <span class="badge bg-success">Verificado SENIAT</span>
                                </p>
                            </div>
                        </div>
                    {% else %}
                        <p class="text-danger">Cliente no encontrado</p>
                    {% endif %}
                </div>
            </div>

            <!-- Productos de la Factura -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-boxes me-2"></i>Productos Facturados
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unit.</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if factura.items and factura.items is iterable and factura.items is not string %}
                                    {% for item in factura.items %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                         style="width: 32px; height: 32px;">
                                                        <i class="fas fa-box text-white"></i>
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold">{{ item.nombre }}</div>
                                                        <small class="text-muted">{{ item.codigo_barras or 'Sin c√≥digo' }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ item.cantidad }}</td>
                                            <td>${{ "%.2f"|format(item.precio_unitario_usd) }}</td>
                                            <td>${{ "%.2f"|format(item.subtotal_usd) }}</td>
                                        </tr>
                                    {% endfor %}
                                {% elif factura.productos and factura.productos is iterable and factura.productos is not string %}
                                    {% set productos_list = factura.productos %}
                                    {% set cantidades_list = factura.cantidades if factura.cantidades and factura.cantidades is iterable and factura.cantidades is not string and factura.cantidades is not callable else [] %}
                                    {% set precios_list = factura.precios if factura.precios and factura.precios is iterable and factura.precios is not string and factura.precios is not callable else [] %}
                                    
                                    {% if productos_list and cantidades_list %}
                                        {% for i in range(productos_list|length) %}
                                            {% if i < cantidades_list|length %}
                                                {% set prod_id = productos_list[i] %}
                                                {% set cantidad = cantidades_list[i]|int if cantidades_list[i] else 0 %}
                                                {% set precio = precios_list[i]|float if precios_list and i < precios_list|length and precios_list[i] else 0 %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                                 style="width: 32px; height: 32px;">
                                                                <i class="fas fa-box text-white"></i>
                                                            </div>
                                                            <div>
                                                                {% if inventario and prod_id and prod_id in inventario %}
                                                                    <div class="fw-bold">{{ inventario[prod_id].nombre }}</div>
                                                                    <small class="text-muted">{{ inventario[prod_id].codigo_barras or 'Sin c√≥digo' }}</small>
                                                                {% else %}
                                                                    <div class="fw-bold">Producto ID: {{ prod_id }}</div>
                                                                    <small class="text-muted">No encontrado</small>
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    <td>{{ cantidad }}</td>
                                                    <td>${{ "%.2f"|format(precio) }}</td>
                                                    <td>${{ "%.2f"|format(precio * cantidad) }}</td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-2x mb-2"></i>
                                            <br>No hay productos registrados
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barra Lateral -->
        <div class="col-lg-4">
            <!-- Resumen de Pagos -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-credit-card me-2"></i>Historial de Pagos
                    </h5>
                </div>
                <div class="card-body">
                    {% if factura.pagos and factura.pagos is iterable and factura.pagos is not string %}
                        <div class="timeline">
                            {% for pago in factura.pagos %}
                                <div class="timeline-item mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-2" 
                                             style="width: 24px; height: 24px;">
                                            <i class="fas fa-check text-white fa-sm"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-bold">${{ "%.2f"|format(pago.monto) }}</div>
                                            <small class="text-muted">{{ pago.fecha }}</small>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="fas fa-credit-card fa-2x mb-2"></i>
                            <br>No hay pagos registrados
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Informaci√≥n de la Factura -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-file-alt me-2"></i>Detalles de la Factura
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6"><strong>N√∫mero:</strong></div>
                        <div class="col-6">{{ factura.numero }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Fecha:</strong></div>
                        <div class="col-6">{{ factura.fecha }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Hora:</strong></div>
                        <div class="col-6">{{ factura.hora }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Secuencial:</strong></div>
                        <div class="col-6">{{ factura.numero_secuencial or factura.secuencial or 'N/A' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Condici√≥n:</strong></div>
                        <div class="col-6">{{ factura.condicion_pago }}</div>
                    </div>
                    {% if factura.vencimiento %}
                        <div class="row mb-2">
                            <div class="col-6"><strong>Vencimiento:</strong></div>
                            <div class="col-6">{{ factura.vencimiento }}</div>
                        </div>
                    {% endif %}
                    <hr>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Subtotal:</strong></div>
                        <div class="col-6">${{ "%.2f"|format(factura.subtotal_usd or factura.subtotal or 0) }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>IVA:</strong></div>
                        <div class="col-6">${{ "%.2f"|format(factura.iva_total or factura.iva or 0) }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>Total USD:</strong></div>
                        <div class="col-6 text-primary fw-bold">${{ "%.2f"|format(factura.total_usd) }}</div>
                    </div>
                    {% if factura.tasa_bcv or factura.tasa_cambio %}
                        <div class="row mb-2">
                            <div class="col-6"><strong>Tasa:</strong></div>
                            <div class="col-6">{{ factura.tasa_bcv or factura.tasa_cambio }}</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- An√°lisis de Productos -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-chart-pie me-2"></i>An√°lisis de Productos
                    </h5>
                </div>
                <div class="card-body">
                    {% if factura.items and factura.items is iterable and factura.items is not string %}
                        <div class="mb-3">
                            <canvas id="productosChart" width="200" height="200"></canvas>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">
                                {{ factura.items|length }} productos facturados
                            </small>
                        </div>
                    {% elif factura.productos and factura.productos is iterable and factura.productos is not string %}
                        <div class="mb-3">
                            <canvas id="productosChart" width="200" height="200"></canvas>
                        </div>
                        <div class="text-center">
                            <small class="text-muted">
                                {{ factura.productos|length }} productos facturados
                            </small>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="fas fa-chart-pie fa-2x mb-2"></i>
                            <br>No hay datos para analizar
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline de Actividad -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0 text-primary">
                        <i class="fas fa-history me-2"></i>Timeline de Actividad
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item mb-3">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                     style="width: 40px; height: 40px;">
                                    <i class="fas fa-file-invoice-dollar text-white"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">Factura creada</div>
                                    <div class="text-muted">{{ factura.fecha }} a las {{ factura.hora }}</div>
                                    <small class="text-muted">Se gener√≥ la factura {{ factura.numero }}</small>
                                </div>
                            </div>
                        </div>
                        
                        {% if factura.pagos and factura.pagos is iterable and factura.pagos is not string %}
                            {% for pago in factura.pagos %}
                                <div class="timeline-item mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fas fa-credit-card text-white"></i>
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-bold">Pago registrado</div>
                                            <div class="text-muted">{{ pago.fecha }}</div>
                                            <small class="text-muted">Monto: ${{ "%.2f"|format(pago.monto) }}</small>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                        
                        {% if saldo_pendiente > 0 %}
                            <div class="timeline-item mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center me-3" 
                                         style="width: 40px; height: 40px;">
                                        <i class="fas fa-clock text-white"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-bold">Pendiente de pago</div>
                                        <div class="text-muted">Saldo pendiente: ${{ "%.2f"|format(saldo_pendiente) }}</div>
                                        <small class="text-muted">Factura vence el {{ factura.vencimiento or 'No especificado' }}</small>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Registrar Pago -->
<div class="modal fade" id="pagoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Pago</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="pagoForm">
                    <div class="mb-3">
                        <label for="montoPago" class="form-label">Monto del Pago</label>
                        <input type="number" class="form-control" id="montoPago" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label for="fechaPago" class="form-label">Fecha del Pago</label>
                        <input type="date" class="form-control" id="fechaPago" required>
                    </div>
                    <div class="mb-3">
                        <label for="notasPago" class="form-label">Notas (opcional)</label>
                        <textarea class="form-control" id="notasPago" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarPago()">Registrar Pago</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Configurar fecha actual en el modal
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('fechaPago').value = new Date().toISOString().split('T')[0];
    
    // Inicializar gr√°fico de productos si existe
    {% if factura.items and factura.items is iterable and factura.items is not string %}
        const ctx = document.getElementById('productosChart').getContext('2d');
        const productos = {{ factura.items|tojson }};
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: productos.map(p => p.nombre),
                datasets: [{
                    data: productos.map(p => p.subtotal_usd),
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 10 }
                        }
                    }
                }
            }
        });
    {% elif factura.productos and factura.productos is iterable and factura.productos is not string %}
        const ctx = document.getElementById('productosChart').getContext('2d');
        const productos = {{ factura.productos|tojson }};
        const cantidades = {{ factura.cantidades|tojson if factura.cantidades else '[]' }};
        const precios = {{ factura.precios|tojson if factura.precios else '[]' }};
        
        // Crear datos para el gr√°fico usando la estructura legacy
        const labels = [];
        const data = [];
        
        for (let i = 0; i < productos.length; i++) {
            if (i < cantidades.length && i < precios.length) {
                const cantidad = parseInt(cantidades[i]) || 0;
                const precio = parseFloat(precios[i]) || 0;
                const total = cantidad * precio;
                
                // Obtener nombre del producto desde inventario si est√° disponible
                const nombre = 'Producto ' + (i + 1);
                labels.push(nombre);
                data.push(total);
            }
        }
        
        if (data.length > 0) {
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });
        }
    {% endif %}
});

// Funciones de acciones r√°pidas
function registrarPago() {
    const modal = new bootstrap.Modal(document.getElementById('pagoModal'));
    modal.show();
}

function confirmarPago() {
    const monto = document.getElementById('montoPago').value;
    const fecha = document.getElementById('fechaPago').value;
    const notas = document.getElementById('notasPago').value;
    
    if (!monto || !fecha) {
        alert('Por favor complete todos los campos requeridos');
        return;
    }
    
    // Aqu√≠ ir√≠a la l√≥gica para enviar el pago al servidor
    alert(`Pago registrado: $${monto} el ${fecha}`);
    
    // Cerrar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('pagoModal'));
    modal.hide();
    
    // Recargar p√°gina para mostrar el nuevo pago
    location.reload();
}

function enviarRecordatorio() {
    if (!confirm('¬øDesea preparar un recordatorio de pago por WhatsApp al cliente?')) {
        return;
    }

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparando...';
    btn.disabled = true;

    try {
        const clienteId = '{{ factura.cliente_id }}';
        const cliente = {{ clientes|tojson }}[clienteId] || {};
        const clienteNombre = cliente.nombre || '{{ factura.cliente_nombre or "Cliente" }}';
        const telefonoRaw = String(cliente.telefono || '').trim();
        const saldoPendiente = {{ (factura.get('saldo_pendiente', 0) or 0) }};
        const numeroFactura = '{{ factura.numero }}';

        // Formatear tel√©fono simple
        let telefono = telefonoRaw.replace(/\D/g, '');
        if (telefono.startsWith('00')) telefono = telefono.slice(2);
        if (telefono.startsWith('0')) telefono = telefono.slice(1);
        if (!telefono.startsWith('58')) telefono = '58' + telefono;

        if (!telefono) {
            alert('El cliente no tiene tel√©fono registrado.');
            return;
        }

        // Mensaje simple basado en esta factura
        const mensaje = `Hola ${clienteNombre}, le recordamos que la factura ${numeroFactura} presenta un saldo pendiente de $${saldoPendiente.toFixed(2)} USD. Por favor, cont√°ctenos para coordinar el pago. Gracias.`;
        const enlaceWhatsapp = `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;

        // Mostrar modal previo al env√≠o
        mostrarModalWhatsApp({
            success: true,
            cliente_nombre: clienteNombre,
            telefono: telefonoRaw || telefono,
            mensaje,
            enlace_whatsapp: enlaceWhatsapp,
            facturas_pendientes: 1,
            total_pendiente: saldoPendiente
        });
    } catch (e) {
        console.error('Error preparando recordatorio en cliente:', e);
        alert('Error inesperado al preparar el recordatorio en el navegador.');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function mostrarModalWhatsApp(data) {
    console.log('üéØ Mostrando modal con datos:', data);
    
    // Validar datos requeridos
    if (!data.enlace_whatsapp) {
        console.error('‚ùå Falta enlace_whatsapp en los datos:', data);
        alert('Error: No se pudo generar el enlace de WhatsApp');
        return;
    }
    
    // Crear modal din√°micamente
    const modalHTML = `
        <div class="modal fade" id="whatsappModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fab fa-whatsapp me-2"></i>Recordatorio Preparado para WhatsApp
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-check-circle me-2"></i>Recordatorio preparado exitosamente
                                </h6>
                                <p><strong>Cliente:</strong> ${data.cliente_nombre || 'N/A'}</p>
                                <p><strong>Tel√©fono:</strong> ${data.telefono || 'N/A'}</p>
                                <p><strong>Facturas pendientes:</strong> ${data.facturas_pendientes || 0}</p>
                                <p><strong>Total pendiente:</strong> $${data.total_pendiente || 0}</p>
                                <p><strong>Mensaje:</strong></p>
                                <div class="border rounded p-3 bg-light">
                                    <pre style="white-space: pre-wrap; font-size: 0.9em;">${data.mensaje || 'Mensaje no disponible'}</pre>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="mb-3">
                                    <i class="fab fa-whatsapp text-success" style="font-size: 4rem;"></i>
                                </div>
                                <p class="text-muted">Haz clic en el bot√≥n para abrir WhatsApp</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <a href="${data.enlace_whatsapp}" 
                           target="_blank" 
                           class="btn btn-success btn-lg">
                            <i class="fab fa-whatsapp me-2"></i>Abrir WhatsApp
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('whatsappModal'));
    modal.show();
    
    // Limpiar modal cuando se cierre
    document.getElementById('whatsappModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function mostrarModalInformeWhatsApp(data) {
    console.log('üéØ Mostrando modal de informe con datos:', data);
    
    // Validar datos requeridos
    if (!data.enlace_whatsapp) {
        console.error('‚ùå Falta enlace_whatsapp en los datos:', data);
        alert('Error: No se pudo generar el enlace de WhatsApp');
        return;
    }
    
    // Crear modal din√°micamente
    const modalHTML = `
        <div class="modal fade" id="informeWhatsappModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-line me-2"></i>Informe de Facturas Preparado para WhatsApp
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-check-circle me-2"></i>Informe preparado exitosamente
                                </h6>
                                <p><strong>Cliente:</strong> ${data.cliente_nombre || 'N/A'}</p>
                                <p><strong>Tel√©fono:</strong> ${data.telefono || 'N/A'}</p>
                                <p><strong>Factura:</strong> ${data.numero_factura || 'N/A'}</p>
                                <p><strong>Saldo pendiente:</strong> $${data.saldo_pendiente || 0}</p>
                                <p><strong>Mensaje del informe:</strong></p>
                                <div class="border rounded p-3 bg-light">
                                    <pre style="white-space: pre-wrap; font-size: 0.9em;">${data.mensaje || 'Mensaje no disponible'}</pre>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="mb-3">
                                    <i class="fas fa-chart-line text-primary" style="font-size: 4rem;"></i>
                                </div>
                                <p class="text-muted">Haz clic en el bot√≥n para abrir WhatsApp</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-info me-2" onclick="copiarMensajeAlPortapapeles('${data.mensaje.replace(/'/g, "\\'")}')">
                            <i class="fas fa-copy me-2"></i>Copiar Mensaje
                        </button>
                        <a href="${data.enlace_web || data.enlace_whatsapp}" target="_blank" class="btn btn-success">
                            <i class="fab fa-whatsapp me-2"></i>Abrir WhatsApp Web
                        </a>
                        <a href="${data.enlace_whatsapp}" target="_blank" class="btn btn-primary btn-lg">
                            <i class="fab fa-whatsapp me-2"></i>Abrir App
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('informeWhatsappModal'));
    modal.show();
    
    // Limpiar modal cuando se cierre
    document.getElementById('informeWhatsappModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

function enviarInformeFacturasPagadas() {
    // Obtener el ID del cliente desde la factura
    const clienteId = '{{ factura.cliente_id }}';
    const cliente = {{ clientes|tojson }}[clienteId] || {};
    const clienteNombre = cliente.nombre || '{{ factura.cliente_nombre or "Cliente" }}';
    
    if (!clienteId) {
        alert('‚ùå Error: No se pudo identificar al cliente');
        return;
    }
    
    // Confirmar env√≠o
    if (!confirm(`¬øDeseas enviar un informe de facturas pagadas por WhatsApp a ${clienteNombre}?\n\nEste informe incluir√°:\n‚Ä¢ Facturas completamente cobradas\n‚Ä¢ Facturas con abonos\n‚Ä¢ Facturas pendientes\n‚Ä¢ Resumen de pagos`)) {
        return;
    }
    
    // Mostrar indicador de carga
    const btn = event.target;
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparando...';
    btn.disabled = true;
    
    try {
        // Generar informe en el frontend
        const telefonoRaw = String(cliente.telefono || '').trim();
        
        // Formatear tel√©fono simple
        let telefono = telefonoRaw.replace(/\D/g, '');
        if (telefono.startsWith('00')) telefono = telefono.slice(2);
        if (telefono.startsWith('0')) telefono = telefono.slice(1);
        if (!telefono.startsWith('58')) telefono = '58' + telefono;
        
        if (!telefono) {
            alert('El cliente no tiene tel√©fono registrado.');
            return;
        }
        
        // Generar mensaje del informe
        const mensaje = `Hola ${clienteNombre}, aqu√≠ tienes tu informe de facturas:\n\n` +
                       `üìä RESUMEN DE FACTURAS:\n` +
                       `‚Ä¢ Factura actual: {{ factura.numero }}\n` +
                       `‚Ä¢ Estado: {{ "Pendiente" if factura.get("saldo_pendiente", 0) > 0 else "Pagada" }}\n` +
                       `‚Ä¢ Saldo: ${{ "%.2f"|format(factura.get("saldo_pendiente", 0)) }} USD\n\n` +
                       `üí° Para m√°s detalles o coordinar pagos, cont√°ctanos. Gracias.`;
        
        // Crear enlaces de WhatsApp con codificaci√≥n correcta
        const mensajeCodificado = encodeURIComponent(mensaje);
        console.log('üì± Mensaje completo:', mensaje);
        console.log('üîó Mensaje codificado:', mensajeCodificado);
        
        // Enlace para app m√≥vil
        const enlaceApp = `https://wa.me/${telefono}?text=${mensajeCodificado}`;
        // Enlace para WhatsApp Web
        const enlaceWeb = `https://web.whatsapp.com/send?phone=${telefono}&text=${mensajeCodificado}`;
        
        // Mostrar modal con el informe
        mostrarModalInformeWhatsApp({
            success: true,
            cliente_nombre: clienteNombre,
            telefono: telefonoRaw || telefono,
            mensaje,
            enlace_whatsapp: enlaceApp,
            enlace_web: enlaceWeb,
            numero_factura: '{{ factura.numero }}',
            saldo_pendiente: {{ factura.get('saldo_pendiente', 0) or 0 }}
        });
        
    } catch (e) {
        console.error('Error preparando informe en cliente:', e);
        alert('Error inesperado al preparar el informe en el navegador.');
    } finally {
        // Restaurar bot√≥n
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

function duplicarFactura() {
    if (confirm('¬øDesea duplicar esta factura?')) {
        // Aqu√≠ ir√≠a la l√≥gica para duplicar la factura
        alert('Factura duplicada correctamente');
    }
}

function probarRecordatorio() {
    // Obtener el ID de la factura desde la URL
    const urlParts = window.location.pathname.split('/');
    const facturaId = urlParts[urlParts.length - 1];
    
    console.log('üß™ Probando sistema de recordatorio para factura:', facturaId);
    
    // Mostrar indicador de carga
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Probando...';
    btn.disabled = true;
    
    // Llamar a la ruta de prueba
    fetch(`/probar-recordatorio-whatsapp/${facturaId}`)
        .then(response => response.json())
        .then(data => {
            console.log('üìä Resultado de la prueba:', data);
            
            if (data.success) {
                alert('‚úÖ Sistema funcionando correctamente!\n\n' +
                      'Factura encontrada: S√≠\n' +
                      'Cliente encontrado: S√≠\n' +
                      'Tel√©fono disponible: S√≠\n' +
                      'Mensaje generado: S√≠\n' +
                      'Enlace generado: S√≠');
            } else {
                let errorMsg = '‚ùå Problemas encontrados:\n\n';
                if (data.errores && data.errores.length > 0) {
                    data.errores.forEach(error => {
                        errorMsg += `‚Ä¢ ${error}\n`;
                    });
                } else {
                    errorMsg += '‚Ä¢ Error desconocido\n';
                }
                alert(errorMsg);
            }
        })
        .catch(error => {
            console.error('‚ùå Error en la prueba:', error);
            alert('‚ùå Error al probar el sistema:\n' + error.message);
        })
        .finally(() => {
            // Restaurar bot√≥n
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function copiarMensajeAlPortapapeles(mensaje) {
    try {
        // El mensaje ya viene decodificado, solo copiarlo
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(mensaje).then(() => {
                alert('‚úÖ Mensaje copiado al portapapeles con emojis');
                console.log('üìã Mensaje copiado:', mensaje);
            }).catch(err => {
                console.error('Error copiando al portapapeles:', err);
                fallbackCopyTextToClipboard(mensaje);
            });
        } else {
            fallbackCopyTextToClipboard(mensaje);
        }
    } catch (e) {
        console.error('Error procesando mensaje para copiar:', e);
        alert('‚ùå Error al copiar el mensaje');
    }
}

// Fallback para navegadores que no soportan clipboard API
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        alert('‚úÖ Mensaje copiado al portapapeles');
        console.log('üìã Mensaje copiado (fallback):', text);
    } catch (err) {
        console.error('Error en fallback copy:', err);
        alert('‚ùå Error al copiar el mensaje');
    }
    
    document.body.removeChild(textArea);
}
</script>

<style>
.timeline-item {
    position: relative;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: 20px;
    top: 40px;
    bottom: -20px;
    width: 2px;
    background-color: #e9ecef;
}

.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}

.progress {
    background-color: #e9ecef;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.btn {
    border-radius: 8px;
}

.badge {
    border-radius: 6px;
}
</style>
{% endblock %}