{% extends "base.html" %}

{% block title %}Reporte de Cuentas por Cobrar{% endblock %}

{% block content %}
<style>
    .reporte-container {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .page-header {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        color: white;
    }

    .page-header h2 {
        font-size: 2rem;
        font-weight: 700;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .stats-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-bottom: 2.5rem;
    }

    .stats-card, .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning {
        flex: 1 1 220px;
        min-width: 220px;
        min-height: 170px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        border: none;
        margin-bottom: 0;
        transition: all 0.3s ease;
        background: white;
    }

    .stats-card {
        background: linear-gradient(135deg, #e3eafc 0%, #f8fafc 100%);
        color: #1a237e;
        border: 1.5px solid #e3eafc;
    }

    .stats-card .stats-icon {
        font-size: 2.8rem;
        margin-bottom: 1rem;
        color: #1976d2;
        opacity: 0.9;
    }

    .stats-card .stats-value {
        font-size: 2.1rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #1a237e;
    }

    .stats-card .stats-label {
        font-size: 1.1rem;
        font-weight: 600;
        opacity: 0.9;
        color: #1976d2;
    }

    .stats-card .text-muted {
        color: #6c757d !important;
        font-size: 0.95rem;
    }

    .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning {
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
    }

    .card.bg-primary { background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%); }
    .card.bg-success { background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%); }
    .card.bg-info { background: linear-gradient(135deg, #0288d1 0%, #01579b 100%); }
    .card.bg-warning { background: linear-gradient(135deg, #f57c00 0%, #e65100 100%); }

    .card .card-title { font-size: 1.1rem; font-weight: 600; }
    .card .mb-0 { font-size: 1.7rem; font-weight: 700; }

    .filtros-cuentas-cobrar {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        border-radius: 12px;
        padding: 0.7rem 1.2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(4, 14, 126, 0.04);
    }

    .filtros-cuentas-cobrar .form-label {
        margin-bottom: 0;
        margin-right: 0.3rem;
        font-size: 1.08rem;
        font-weight: 700;
        color: #fff !important;
        letter-spacing: 0.5px;
        text-shadow: 0 1px 4px #0d47a1, 0 0 2px #fff;
    }

    .filtros-cuentas-cobrar .form-select {
        display: inline-block;
        margin-right: 0.5rem;
        font-size: 1rem;
        padding: 0.3rem 1.2rem 0.3rem 0.5rem;
        border: 1.5px solid #90caf9;
        background: #e3eafc;
        color: #1a237e;
        font-weight: 600;
        box-shadow: 0 2px 8px rgba(26,35,126,0.04);
        transition: border 0.2s;
        border-radius: 8px;
        min-width: 80px;
    }

    .filtros-cuentas-cobrar .form-select:focus {
        border: 2px solid #1976d2;
        outline: none;
        background: #fff;
    }

    .filtros-cuentas-cobrar .btn-dark, .filtros-cuentas-cobrar .btn-dark:focus {
        background: #fff !important;
        color: #1a237e !important;
        border: 2px solid #1a237e;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(26,35,126,0.08);
    }

    .filtros-cuentas-cobrar .btn-dark:hover {
        background: #e3eafc !important;
        color: #0d47a1 !important;
        border: 2px solid #1976d2;
    }

    .filtros-cuentas-cobrar .btn {
        margin-bottom: 0.3rem;
    }

    .table-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        border: none;
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .table-card .card-header {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        color: white;
        padding: 1.2rem 1.5rem;
        border-bottom: none;
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .table-card .card-header.danger {
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
    }

    .table-card .card-header.info {
        background: linear-gradient(135deg, #0288d1 0%, #01579b 100%);
    }

    .table thead th {
        background: #f8f9fa;
        color: #1a237e;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
        padding: 0.9rem 0.7rem;
        font-size: 1rem;
    }

    .table tbody td {
        padding: 0.8rem 0.7rem;
        vertical-align: middle;
        font-size: 0.98rem;
    }

    .table tbody tr {
        transition: all 0.3s ease;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
        transform: scale(1.01);
    }

    .badge {
        padding: 0.5rem 1rem;
        font-weight: 600;
        border-radius: 8px;
        font-size: 0.95rem;
    }

    .badge-success {
        background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
    }

    .badge-warning {
        background: linear-gradient(135deg, #f57c00 0%, #e65100 100%);
    }

    .badge-secondary {
        background: linear-gradient(135deg, #455a64 0%, #263238 100%);
    }

    .badge.bg-info {
        background: linear-gradient(135deg, #0288d1 0%, #b3e5fc 100%) !important;
        color: #01579b !important;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .btn i {
        font-size: 1.1rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        border: none;
    }

    .btn-outline-primary {
        border: 2px solid #1a237e;
        color: #1a237e;
    }

    .btn-outline-primary:hover, .btn-outline-primary.active {
        background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
        border-color: transparent;
    }

    .btn-outline-success {
        border: 2px solid #2e7d32;
        color: #2e7d32;
    }

    .btn-outline-success:hover, .btn-outline-success.active {
        background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        border-color: transparent;
        color: white;
    }

    .btn-outline-secondary {
        border: 2px solid #455a64;
        color: #455a64;
    }

    .btn-outline-secondary:hover, .btn-outline-secondary.active {
        background: linear-gradient(135deg, #455a64 0%, #263238 100%);
        border-color: transparent;
        color: white;
    }

    .btn-info {
        background: linear-gradient(135deg, #0288d1 0%, #01579b 100%);
        border: none;
    }

    .btn-sm {
        padding: 0.5rem;
        font-size: 0.9rem;
    }

    @media (max-width: 1200px) {
        .stats-row { flex-direction: column; gap: 1rem; }
        .stats-card, .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning { min-width: 100%; }
    }

    @media (max-width: 768px) {
        .page-header { padding: 1.5rem; }
        .page-header h2 { font-size: 1.5rem; }
        .stats-row { flex-direction: column; gap: 1rem; }
        .stats-card, .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning { min-width: 100%; }
        .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        .table thead th, .table tbody td { padding: 0.75rem; font-size: 0.9rem; }
    }

    @media print {
        .btn-group, .navbar { display: none !important; }
        .card { break-inside: avoid; border: none !important; }
        .card-header { background-color: #f8f9fa !important; color: #000 !important; border-bottom: 2px solid #dee2e6 !important; }
        .table { font-size: 12px; }
        .table th { background-color: #f8f9fa !important; color: #000 !important; }
        .badge { border: 1px solid #000; }
        .container-fluid { width: 100% !important; padding: 0 !important; }
        .row { margin: 0 !important; }
        .col-md-3, .col-md-2 { padding: 0 10px !important; }
        .stats-value { font-size: 2rem !important; }
    }

    .row.align-cards {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        margin-bottom: 2.5rem;
    }
    .table-card, .bcv-card-animated {
        flex: 1 1 350px;
        min-width: 320px;
        min-height: 320px;
        display: flex;
        flex-direction: column;
        justify-content: stretch;
        align-items: stretch;
    }
    .bcv-card-animated {
        background: linear-gradient(135deg, #e3eafc 0%, #f8fafc 100%);
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        border: 1.5px solid #e3eafc;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        animation: fadeInSlide 1.1s cubic-bezier(.4,0,.2,1);
    }
    @keyframes fadeInSlide {
        0% { opacity: 0; transform: translateY(40px) scale(0.98); }
        60% { opacity: 0.7; transform: translateY(-8px) scale(1.01); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .bcv-card-animated .stats-label {
        color: #1976d2;
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    .bcv-card-animated .stats-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: #1a237e;
        margin-bottom: 0.5rem;
        transition: color 0.3s, background 0.3s;
    }
    .bcv-card-animated.updated {
        animation: flashUpdate 0.8s;
        background: linear-gradient(135deg, #d1eaff 0%, #e3eafc 100%);
    }
    @keyframes flashUpdate {
        0% { background: #fffbe7; }
        40% { background: #d1eaff; }
        100% { background: linear-gradient(135deg, #e3eafc 0%, #f8fafc 100%); }
    }
    .bcv-card-animated .text-muted {
        color: #6c757d !important;
        font-size: 1rem;
    }
    .bcv-card-animated .last-update {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 1rem;
        color: #1976d2;
        margin-top: 0.5rem;
    }
    .bcv-card-animated .refresh-rotate {
        display: inline-block;
        animation: rotateRefresh 1.2s linear infinite;
        font-size: 1.1rem;
        color: #1976d2;
    }
    @keyframes rotateRefresh {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    @media (max-width: 1200px) {
        .row.align-cards { flex-direction: column; gap: 1rem; }
        .table-card, .bcv-card-animated { min-width: 100%; min-height: 220px; }
    }
    .facturas-carrusel { display: flex; align-items: center; justify-content: center; }
    .carrusel-inner { display: flex; transition: transform 0.5s cubic-bezier(.4,0,.2,1); width: 100%; overflow: hidden; }
    .carrusel-item { min-width: 100%; max-width: 100%; box-sizing: border-box; padding: 1rem 0.5rem; text-align: center; background: rgba(255,255,255,0.07); border-radius: 10px; margin: 0 0.2rem; }
    .carrusel-btn { background: none; border: none; color: #fff; font-size: 1.5rem; padding: 0 0.5rem; cursor: pointer; transition: color 0.2s; z-index: 2; }
    .carrusel-btn:hover { color: #ffd600; }
    @media (min-width: 900px) {
        .carrusel-item { min-width: 320px; max-width: 320px; }
        .carrusel-inner { width: 320px; }
    }
    @media (max-width: 900px) {
        .carrusel-item { min-width: 100%; max-width: 100%; }
        .carrusel-inner { width: 100%; }
    }
    .btn-por-cobrar {
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%) !important;
        color: #fff !important;
        border: none !important;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(211,47,47,0.12);
        text-shadow: 0 1px 2px #b71c1c;
        letter-spacing: 0.5px;
        border-radius: 10px;
        transition: all 0.2s;
    }
    .btn-por-cobrar.active, .btn-por-cobrar:focus {
        outline: 3px solid #d32f2f;
        outline-offset: 2px;
        box-shadow: 0 0 0 0.2rem rgba(211,47,47,0.25);
    }
    .btn-por-cobrar:hover {
        background: linear-gradient(135deg, #b71c1c 0%, #d32f2f 100%) !important;
        color: #fff !important;
        transform: translateY(-2px) scale(1.03);
    }
</style>

<div class="reporte-container">
    <div class="container">
        <div class="page-header">
            <div class="row align-items-center">
                <div class="col-md-12">
                    <h2><i class="fas fa-money-bill-wave me-2"></i>Reporte de Cuentas por Cobrar</h2>
                    <div class="filtros-cuentas-cobrar mt-3 mb-2" style="flex-wrap:wrap;align-items:center;">
                        <span style="font-weight:600;font-size:1.1rem;margin-right:1rem;color:#fff;">Filtrar por estado:</span>
                        <a href="{{ url_for('mostrar_cuentas_por_cobrar', estado='por_cobrar', mes=mes_seleccionado, anio=anio_seleccionado) }}" class="btn btn-por-cobrar {% if filtro == 'por_cobrar' %}active{% endif %}"><i class="fas fa-hourglass-half me-1"></i>Por Cobrar</a>
                        <a href="{{ url_for('mostrar_cuentas_por_cobrar', estado='abonada', mes=mes_seleccionado, anio=anio_seleccionado) }}" class="btn btn-info {% if filtro == 'abonada' %}active{% endif %}"><i class="fas fa-hand-holding-usd me-1"></i>Abonadas</a>
                        <a href="{{ url_for('mostrar_cuentas_por_cobrar', estado='cobrada', mes=mes_seleccionado, anio=anio_seleccionado) }}" class="btn btn-success {% if filtro == 'cobrada' %}active{% endif %}"><i class="fas fa-check-circle me-1"></i>Cobradas</a>
                        <a href="{{ url_for('mostrar_cuentas_por_cobrar', estado='todas', mes=mes_seleccionado, anio=anio_seleccionado) }}" class="btn btn-secondary {% if filtro == 'todas' %}active{% endif %}"><i class="fas fa-list me-1"></i>Todas</a>
                        <form method="get" action="{{ url_for('mostrar_cuentas_por_cobrar') }}" class="d-flex align-items-center" style="margin-left:1.5rem;gap:0.5rem;">
                            <input type="hidden" name="estado" value="{{ filtro }}">
                            <label for="mes" class="form-label">Mes:</label>
                            <select name="mes" id="mes" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">Todos</option>
                                {% for m in range(1, 13) %}
                                    <option value="{{ m }}" {% if mes_seleccionado == m %}selected{% endif %}>{{ "{:02d}".format(m) }}</option>
                                {% endfor %}
                            </select>
                            <label for="anio" class="form-label">A√±o:</label>
                            <select name="anio" id="anio" class="form-select form-select-sm" style="min-width:90px;" onchange="this.form.submit()">
                                <option value="">Todos</option>
                                {% for a in anios_disponibles %}
                                    <option value="{{ a }}" {% if anio_seleccionado == a %}selected{% endif %}>{{ a }}</option>
                                {% endfor %}
                            </select>
                            <label for="cliente" class="form-label">Cliente:</label>
                            <select name="cliente" id="cliente" class="form-select form-select-sm" style="min-width:200px;" onchange="this.form.submit()">
                                <option value="">Todos los clientes</option>
                                {% for cliente in clientes_disponibles %}
                                    <option value="{{ cliente.id }}" {% if cliente_seleccionado == cliente.id %}selected{% endif %}>{{ cliente.nombre }}</option>
                                {% endfor %}
                            </select>
                            {% if filtro == 'por_cobrar' %}
                            <label class="form-label ms-2">Solo vencidas:</label>
                            <input type="hidden" name="solo_vencidas" value="0">
                            <input type="checkbox" name="solo_vencidas" value="1" class="form-check-input" {% if solo_vencidas %}checked{% endif %} onchange="this.form.submit()">
                            {% endif %}
                        </form>
                        {% if cliente_seleccionado %}
                        <a href="{{ url_for('mostrar_cuentas_por_cobrar', estado=filtro, mes=mes_seleccionado, anio=anio_seleccionado) }}" class="btn btn-outline-warning btn-sm ms-2" title="Quitar filtro de cliente">
                            <i class="fas fa-times me-1"></i>Quitar cliente
                        </a>
                        {% endif %}
                        <button onclick="window.print()" class="btn btn-dark ms-2">
                            <i class="fas fa-print me-2"></i>Imprimir
                        </button>
                        <!-- Bot√≥n para enviar informe de facturas pagadas -->
                        {% if cliente_seleccionado %}
                        <button onclick="enviarInformeFacturasPagadas('{{ cliente_seleccionado }}', '{{ cliente_nombre_seleccionado }}')" 
                                class="btn btn-primary ms-2" 
                                title="Enviar informe de facturas pagadas a {{ cliente_nombre_seleccionado }}">
                            <i class="fas fa-chart-line me-2"></i>Informe Facturas
                        </button>
                        {% endif %}
                        <!-- Bot√≥n de prueba de emojis -->
                        <button onclick="probarEmojis('Hola, este es un mensaje de prueba con emojis: üìä üìã üìÖ üî¥ üü° üü¢ ‚ö†Ô∏è üí°')" 
                                class="btn btn-warning ms-2" 
                                title="Probar funciones de emojis">
                            <i class="fas fa-bug me-2"></i>Probar Emojis
                        </button>
                    </div>
                    <div class="mb-4" style="font-size:1rem;color:#e3eafc;">
                        <span>Los totales globales siempre reflejan todas las facturas. La tabla y el conteo de facturas respetan el filtro seleccionado.</span>
                        {% if cliente_seleccionado %}
                        <div class="mt-2 p-2" style="background:rgba(255,193,7,0.2);border-radius:8px;border-left:4px solid #ffc107;">
                            <i class="fas fa-filter me-2"></i><strong>Filtrado por cliente:</strong> {{ cliente_nombre_seleccionado }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficas de resumen -->
        <div class="row mb-4">
            <div class="col-md-7 mb-3 mb-md-0">
                <div class="card" style="padding:1.5rem;min-height:340px;">
                    <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i>{% if filtro == 'abonada' %}Resumen Abonadas (USD, Facturas y Promedio Abonado){% elif filtro == 'cobrada' %}Resumen Cobradas (USD y Facturas){% else %}Resumen General (USD, Facturas y Promedio){% endif %}</h5>
                    <canvas id="graficaBarras"></canvas>
                </div>
            </div>
            <div class="col-md-5">
                <div class="card" style="padding:1.5rem;min-height:340px;">
                    <h5 class="mb-3">
                        {% if filtro == 'por_cobrar' %}
                        <i class="fas fa-user-tie me-2"></i>Top Deudores (USD)
                        {% elif filtro in ['abonada','cobrada'] %}
                        <i class="fas fa-hand-holding-usd me-2"></i>Top Clientes (USD)
                        {% else %}
                        <i class="fas fa-chart-pie me-2"></i>Distribuci√≥n
                        {% endif %}
                    </h5>
                    <canvas id="graficaPastel"></canvas>
                </div>
            </div>
        </div>

        <!-- Resumen de Cuentas por Cobrar -->
        <div class="stats-row" id="stats-row">
            <div class="card bg-secondary text-white">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title">Total Facturado</h5>
                    {% if filtro in ['abonada','cobrada'] %}
                    <h3 class="mb-0">${{ display_facturado_usd|es_number }}</h3>
                    <small class="text-light">Bs. {{ (display_facturado_usd * tasa_bcv)|es_number }}</small>
                    {% else %}
                    <h3 class="mb-0">${{ total_facturado_usd|es_number }}</h3>
                    <small class="text-light">Bs. {{ total_facturado_bs|es_number }}</small>
                    {% endif %}
                </div>
            </div>
            <div class="card bg-success text-white">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title">Total Abonado</h5>
                    {% if filtro in ['abonada','cobrada'] %}
                    <h3 class="mb-0">${{ display_abonado_usd|es_number }}</h3>
                    <p class="mb-0">Bs. {{ (display_abonado_usd * tasa_bcv)|es_number }}</p>
                    {% else %}
                    <h3 class="mb-0">${{ total_abonado_usd|es_number }}</h3>
                    <p class="mb-0">Bs. {{ total_abonado_bs|es_number }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="card bg-primary text-white">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title">Total por Cobrar</h5>
                    {% if filtro in ['abonada','cobrada'] %}
                    <h3 class="mb-0">${{ display_por_cobrar_usd|es_number }}</h3>
                    <p class="mb-0">Bs. {{ (display_por_cobrar_usd * tasa_bcv)|es_number }}</p>
                    {% else %}
                    <h3 class="mb-0">${{ total_por_cobrar_usd|es_number }}</h3>
                    <p class="mb-0">Bs. {{ total_por_cobrar_bs|es_number }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="card bg-info text-white">
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <h5 class="card-title">Total de Facturas</h5>
                    <h3 class="mb-0">{{ cantidad_facturas }}</h3>
                </div>
            </div>
        </div>

        {% if filtro == 'cobrada' and resumen_cobradas %}
        <div class="row mb-3" style="gap:1rem;">
            <div class="col-md-4">
                <div class="card" style="border-left:6px solid #2e7d32;">
                    <div class="card-body">
                        <div style="font-weight:700;color:#2e7d32;">Facturas cobradas</div>
                        <div style="font-size:1.6rem;font-weight:800;">{{ resumen_cobradas.facturas }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card" style="border-left:6px solid #0288d1;">
                    <div class="card-body">
                        <div style="font-weight:700;color:#0288d1;">Ticket promedio</div>
                        <div style="font-size:1.6rem;font-weight:800;">${{ resumen_cobradas.ticket_promedio|es_number }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card" style="border-left:6px solid #f57c00;">
                    <div class="card-body">
                        <div style="font-weight:700;color:#f57c00;">Cliente con mayor pago</div>
                        <div style="font-weight:700;">{{ resumen_cobradas.cliente_top }}</div>
                        <div style="font-size:1.2rem;font-weight:800;">${{ resumen_cobradas.monto_top|es_number }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-12">
                <div class="card" style="border-left:6px solid #455a64;">
                    <div class="card-body d-flex flex-wrap" style="gap:2rem;align-items:center;">
                        <div><strong>M√≠nimo:</strong> ${{ resumen_cobradas.min_pagado|es_number }}</div>
                        <div><strong>Mediana:</strong> ${{ resumen_cobradas.mediana_pagado|es_number }}</div>
                        <div><strong>M√°ximo:</strong> ${{ resumen_cobradas.max_pagado|es_number }}</div>
                        <div><strong>√öltima cobranza:</strong> {{ resumen_cobradas.ultima_cobranza or '-' }}</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- KPIs din√°micos por estado -->
        <div class="stats-row">
            {% if filtro == 'por_cobrar' %}
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-bell"></i></div><div class="stats-label">Saldo Vencido (USD)</div><div class="stats-value">${{ (kpis.saldo_vencido_usd or 0)|es_number }}</div></div></div>
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-clock"></i></div><div class="stats-label">Saldo No Vencido (USD)</div><div class="stats-value">${{ (kpis.saldo_no_vencido_usd or 0)|es_number }}</div></div></div>
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-user-shield"></i></div><div class="stats-label">Concentraci√≥n Top 5</div><div class="stats-value">{{ (kpis.concentracion_top5 or 0) }}%</div></div></div>
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-receipt"></i></div><div class="stats-label">Ticket Promedio (USD)</div><div class="stats-value">${{ (kpis.ticket_promedio_usd or 0)|es_number }}</div></div></div>
            {% elif filtro == 'abonada' %}
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-hand-holding-usd"></i></div><div class="stats-label">Abonado (USD)</div><div class="stats-value">${{ (kpis.total_abonado_set or 0)|es_number }}</div></div></div>
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-balance-scale"></i></div><div class="stats-label">Saldo Pendiente (USD)</div><div class="stats-value">${{ (kpis.saldo_pendiente_set or 0)|es_number }}</div></div></div>
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-percentage"></i></div><div class="stats-label">Progreso Recuperaci√≥n</div><div class="stats-value">{{ (kpis.progreso_recuperacion or 0) }}%</div></div></div>
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-receipt"></i></div><div class="stats-label">Promedio Abonado</div><div class="stats-value">${{ (kpis.promedio_abonado_set or 0)|es_number }}</div></div></div>
            {% elif filtro == 'cobrada' %}
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-check-circle"></i></div><div class="stats-label">Total Pagado (USD)</div><div class="stats-value">${{ (kpis.total_pagado_set or 0)|es_number }}</div></div></div>
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-receipt"></i></div><div class="stats-label">Promedio Pagado</div><div class="stats-value">${{ (kpis.promedio_pagado_set or 0)|es_number }}</div></div></div>
            <div class="card stats-card"><div class="card-body d-flex flex-column align-items-center justify-content-center"><div class="stats-icon"><i class="fas fa-user-tie"></i></div><div class="stats-label">Concentraci√≥n Top 1</div><div class="stats-value">{{ (kpis.concentracion_top1 or 0) }}%</div></div></div>
            {% endif %}
        </div>

        <!-- Top Deudores y Tasa BCV -->
        <div class="row align-cards">
            <div class="col-md-6" style="display:flex;flex:1;">
                <div class="table-card" style="width:100%;">
                    <div class="card-header {% if filtro == 'abonada' %}info{% else %}danger{% endif %}">
                        <h5>
                            {% if filtro == 'abonada' %}
                            <i class="fas fa-hand-holding-usd me-2"></i>Top 10 Clientes Abonados
                            {% elif filtro == 'cobrada' %}
                            <i class="fas fa-check-circle me-2"></i>Top 5 Clientes Buena Paga
                            {% else %}
                            <i class="fas fa-exclamation-triangle me-2"></i>Top 5 Clientes Deudores
                            {% endif %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Cliente</th>
                                        {% if filtro == 'abonada' %}
                                        <th class="text-end">Total Abonado (USD)</th>
                                        <th class="text-end">Total Facturado (USD)</th>
                                        <th class="text-end">Facturas</th>
                                        <th class="text-end">Participaci√≥n</th>
                                        <th class="text-end">Ticket Promedio</th>
                                        {% elif filtro == 'cobrada' %}
                                        <th class="text-end">Total Pagado (USD)</th>
                                        <th class="text-end">Total Facturado (USD)</th>
                                        <th class="text-end">Facturas</th>
                                        <th class="text-end">Participaci√≥n</th>
                                        <th class="text-end">Ticket Promedio</th>
                                        {% else %}
                                        <th class="text-end">Monto Pendiente (USD)</th>
                                        <th class="text-end">Participaci√≥n</th>
                                        <th class="text-end">Ticket Promedio</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for d in top_deudores %}
                                    <tr>
                                        <td>
                                            <a href="{{ url_for('mostrar_cuentas_por_cobrar', estado=filtro, mes=mes_seleccionado, anio=anio_seleccionado, cliente=d.cliente_id) }}" class="text-decoration-none">
                                                {{ d.cliente }}
                                            </a>
                                        </td>
                                        {% if filtro == 'abonada' %}
                                        <td class="text-end">${{ d.get('abonado_usd', 0)|es_number }}</td>
                                        <td class="text-end">${{ d.get('total_facturado', 0)|es_number }}</td>
                                        <td class="text-end">{{ d.get('facturas', 0) }}</td>
                                        <td class="text-end">{{ d.get('participacion', 0) }}%</td>
                                        <td class="text-end">${{ d.get('ticket_promedio', 0)|es_number }}</td>
                                        {% elif filtro == 'cobrada' %}
                                        <td class="text-end">${{ d.get('abonado_usd', 0)|es_number }}</td>
                                        <td class="text-end">${{ d.get('total_facturado', 0)|es_number }}</td>
                                        <td class="text-end">{{ d.get('facturas', 0) }}</td>
                                        <td class="text-end">{{ d.get('participacion', 0) }}%</td>
                                        <td class="text-end">${{ d.get('ticket_promedio', 0)|es_number }}</td>
                                        {% else %}
                                        <td class="text-end">${{ d.get('monto', 0)|es_number }}</td>
                                        <td class="text-end">{{ d.get('participacion', 0) }}%</td>
                                        <td class="text-end">${{ d.get('ticket_promedio', 0)|es_number }}</td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6" style="display:flex;flex:1;">
                <div class="table-card" style="width:100%;">
                    <div class="card-header info">
                        <h5><i class="fas fa-chart-bar me-2"></i>Antig√ºedad de Cartera</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="graficaAntiguedad"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Eliminado duplicado de Antig√ºedad de Cartera -->

        <!-- Tabla de Cuentas por Cobrar -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    {% if filtro == 'cobrada' %}
                    Detalle de Cuentas Cobradas
                    {% elif filtro == 'abonada' %}
                    Detalle de Cuentas Abonadas
                    {% else %}
                    Detalle de Cuentas por Cobrar
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Factura</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Edad (d√≠as)</th>
                                <th>Vence</th>
                                <th>D√≠as vencidos</th>
                                <th>Total USD</th>
                                <th>Abonado USD</th>
                                <th>Saldo USD</th>
                                <th>Estado</th>
                                <th>Condici√≥n de Pago</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for id, cuenta in cuentas.items() %}
                            <tr>
                                <td>{{ cuenta['numero'] }}</td>
                                <td>{{ cuenta['cliente_nombre'] }}</td>
                                <td>{{ cuenta['fecha'] }}</td>
                                <td>{{ cuenta.get('edad_dias','') }}</td>
                                <td>{{ cuenta.get('fecha_vencimiento','') }}</td>
                                <td>
                                    {% set dv = cuenta.get('dias_vencidos', 0) %}
                                    {% if dv > 0 %}
                                        <span class="badge bg-danger">{{ dv }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>${{ cuenta['total_usd']|es_number }}</td>
                                <td>${{ cuenta['abonado_usd']|es_number }}</td>
                                <td>${{ cuenta['saldo_pendiente']|es_number }}</td>
                                <td>
                                    {% if cuenta['estado'] == 'cobrada' %}
                                    <span class="badge bg-success">Cobrada</span>
                                    {% elif cuenta['estado'] == 'abonada' %}
                                    <span class="badge bg-info text-dark">Abonada</span>
                                    {% else %}
                                    <span class="badge bg-warning">Por Cobrar</span>
                                    {% if cuenta.get('dias_vencidos', 0) > 0 %}
                                    <span class="badge bg-danger ms-1">Vencida</span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                                <td>{{ cuenta['condicion_pago'] }}</td>
                                <td>
                                    <a href="{{ url_for('ver_factura', id=id) }}" class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if cuenta['estado'] == 'por_cobrar' %}
                                    <a href="{{ url_for('registrar_pago', id=id) }}" class="btn btn-sm btn-success">
                                        <i class="fas fa-dollar-sign"></i>
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script id="data-antiguedad" type="application/json">{{ grafica_antiguedad|tojson }}</script>
<script id="data-barras" type="application/json">{{ grafica_barras|tojson }}</script>
<script id="data-pastel" type="application/json">{{ grafica_pastel|tojson }}</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Gr√°fica de antig√ºedad (5 barras: No vencida, 0-30, 31-60, 61-90, 90+)
(function(){
  var antigRaw = document.getElementById('data-antiguedad');
  var antig = antigRaw ? JSON.parse(antigRaw.textContent || '{}') : {};
  var antigLabels = Array.isArray(antig.labels) ? antig.labels : [];
  var antigData = Array.isArray(antig.data) ? antig.data : [];
  var ctxAntig = document.getElementById('graficaAntiguedad').getContext('2d');
  new Chart(ctxAntig, {
    type: 'bar',
    data: {
      labels: antigLabels,
      datasets: [{
        label: 'Monto (USD)',
        data: antigData,
        backgroundColor: [
          'rgba(25,135,84,0.8)',
          'rgba(13,110,253,0.8)',
          'rgba(2,136,209,0.8)',
          'rgba(255,193,7,0.8)',
          'rgba(211,47,47,0.8)'
        ],
        borderRadius: 8,
        maxBarThickness: 50
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });
})();

let carruselIndex = 0;
const items = document.querySelectorAll('.carrusel-item');
const inner = document.getElementById('carrusel-inner');
function updateCarrusel() {
    if (items.length === 0) return;
    let width = items[0].offsetWidth;
    inner.style.transform = `translateX(-${carruselIndex * width}px)`;
}
function moveCarrusel(dir) {
    if (items.length === 0) return;
    carruselIndex += dir;
    if (carruselIndex < 0) carruselIndex = 0;
    if (carruselIndex > items.length - 1) carruselIndex = items.length - 1;
    updateCarrusel();
}
window.addEventListener('resize', updateCarrusel);
document.addEventListener('DOMContentLoaded', updateCarrusel);
</script>

<script>
(function(){
  var barrasRaw = document.getElementById('data-barras');
  var barras = barrasRaw ? JSON.parse(barrasRaw.textContent || '{}') : {};
  var barrasLabels = Array.isArray(barras.labels) ? barras.labels : [];
  var barrasData = Array.isArray(barras.data) ? barras.data : [];
  var barrasFacturas = Array.isArray(barras.facturas) ? barras.facturas : [];
  var barrasAvg = Array.isArray(barras.avg) ? barras.avg : [];
  var totalUSD0 = barrasData[0] || 1;

  var ctxBarras = document.getElementById('graficaBarras').getContext('2d');
  var graficaBarras = new Chart(ctxBarras, {
      type: 'bar',
      data: {
          labels: barrasLabels,
          datasets: [
              {
                  label: 'Monto (USD)',
                  data: barrasData,
                  backgroundColor: [
                      'rgba(26,35,126,0.85)',
                      'rgba(211,47,47,0.85)',
                      'rgba(46,125,50,0.85)'
                  ],
                  borderRadius: 8,
                  maxBarThickness: 60
              },
              {
                  label: 'Cantidad de Facturas',
                  data: barrasFacturas,
                  backgroundColor: [
                      'rgba(255,193,7,0.5)',
                      'rgba(211,47,47,0.3)',
                      'rgba(46,125,50,0.3)'
                  ],
                  type: 'line',
                  yAxisID: 'y1',
                  borderColor: 'rgba(255,193,7,1)',
                  borderWidth: 3,
                  pointBackgroundColor: 'rgba(255,193,7,1)',
                  fill: false
              },
              {
                  label: '{{ "Promedio abonado (USD/Factura)" if filtro == "abonada" else ("Promedio pagado (USD/Factura)" if filtro == "cobrada" else "Promedio (USD/Factura)") }}',
                  data: barrasAvg,
                  type: 'line',
                  yAxisID: 'y2',
                  borderColor: 'rgba(2,136,209,0.9)',
                  backgroundColor: 'rgba(2,136,209,0.2)',
                  borderWidth: 3,
                  pointBackgroundColor: 'rgba(2,136,209,1)',
                  tension: 0.3,
                  fill: false
              }
          ]
      },
      options: {
          responsive: true,
          plugins: {
              legend: { position: 'top' },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          const label = context.dataset.label || '';
                          const val = context.parsed.y;
                          if (label.includes('Monto')) {
                              return `${label}: $${val.toLocaleString('es-VE', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
                          }
                          if (label.includes('Promedio')) {
                              return `${label}: $${val.toLocaleString('es-VE', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
                          }
                          return `${label}: ${val}`;
                      }
                  }
              }
          },
          scales: {
              y: { beginAtZero: true, title: { display: true, text: 'Monto (USD)' } },
              y1: {
                  beginAtZero: true,
                  position: 'right',
                  grid: { drawOnChartArea: false },
                  title: { display: true, text: 'Cantidad de Facturas' }
              },
              y2: {
                  beginAtZero: true,
                  position: 'right',
                  grid: { drawOnChartArea: false },
                  title: { display: true, text: 'Promedio (USD/Factura)' }
              }
          }
      }
  });
})();

// Gr√°fica de Pastel Mejorada
(function(){
  var pastelRaw = document.getElementById('data-pastel');
  var pastel = pastelRaw ? JSON.parse(pastelRaw.textContent || '{}') : {};
  var pastelLabels = Array.isArray(pastel.labels) ? pastel.labels : [];
  var pastelData = Array.isArray(pastel.data) ? pastel.data : [];
  var totalPastel = pastelData.reduce(function(a, b){ return a + b; }, 0) || 1;

  var ctxPastel = document.getElementById('graficaPastel').getContext('2d');
  // Nueva paleta con fallback HSL determin√≠stico por etiqueta
  var baseColors = ['#1E88E5','#43A047','#E53935','#8E24AA','#FB8C00','#00ACC1','#7CB342','#5E35B1','#F4511E','#3949AB','#00897B','#FDD835'];
  function hashCode(str){ var h=0; for (var i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return Math.abs(h); }
  function colorFromLabel(lbl){ var h = hashCode(lbl) % 360; return 'hsl(' + h + ' 70% 45%)'; }
  var sliceColors = pastelLabels.map(function(lbl, idx){ return baseColors[idx] || colorFromLabel(lbl); });

  var graficaPastel = new Chart(ctxPastel, {
      type: 'doughnut',
      data: {
          labels: pastelLabels,
          datasets: [{
              data: pastelData,
              backgroundColor: sliceColors,
              borderColor: '#ffffff',
              borderWidth: 2,
              hoverOffset: 6
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: { position: 'bottom', labels: { usePointStyle: true } },
              tooltip: {
                  callbacks: {
                      label: function(context) {
                          const val = context.parsed || 0;
                          const percent = ((val / totalPastel) * 100).toFixed(1);
                          const formatted = val.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                          return `${context.label}: $${formatted} (${percent}%)`;
                      }
                  }
              }
          },
          cutout: '55%'
      }
  });
})();
</script>

<!-- Script de antig√ºedad duplicado eliminado -->

<script>
// Funcionalidad para enviar recordatorios de cuentas por cobrar por WhatsApp
function enviarRecordatorioCuentasPorCobrar(clienteId, clienteNombre) {
    console.log('üîç Funci√≥n llamada con:', { clienteId, clienteNombre });
    
    if (!clienteId) {
        alert('Error: No se pudo identificar al cliente');
        return;
    }
    
    // Confirmar env√≠o
    if (!confirm(`¬øDeseas enviar un recordatorio de cuentas por cobrar por WhatsApp a ${clienteNombre}?`)) {
        return;
    }
    
    // Mostrar indicador de carga
    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    const url = `/cuentas-por-cobrar/enviar_recordatorio_whatsapp`;
    console.log('üì° Enviando solicitud a:', url);
    
    // Enviar solicitud al servidor
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ cliente_id: clienteId })
    })
            .then(response => {
            console.log('üì° Respuesta del servidor:', response.status, response.statusText);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Datos recibidos:', data);
            if (data.success) {
                // Mostrar modal de WhatsApp en lugar de confirm
                mostrarModalWhatsAppCuentasPorCobrar(data);
            } else {
                alert(`‚ùå Error: ${data.error || 'No se pudo preparar el recordatorio'}`);
            }
        })
    .catch(error => {
        console.error('‚ùå Error completo:', error);
        console.error('‚ùå Stack trace:', error.stack);
        
        let errorMessage = '‚ùå Error de conexi√≥n. ';
        if (error.message.includes('HTTP')) {
            errorMessage += `Error del servidor: ${error.message}`;
        } else if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMessage += 'No se pudo conectar con el servidor. Verifica tu conexi√≥n a internet.';
        } else {
            errorMessage += `Error: ${error.message}`;
        }
        
        alert(errorMessage);
    })
    .finally(() => {
        // Restaurar bot√≥n
        btn.innerHTML = originalContent;
        btn.disabled = false;
    });
}

// Funci√≥n para mostrar informaci√≥n detallada del recordatorio
function mostrarDetallesRecordatorio(data) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üì± Recordatorio WhatsApp Preparado</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Recordatorio preparado exitosamente</h6>
                        <p class="mb-0">Cliente: <strong>${data.cliente_nombre}</strong></p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle"></i> Informaci√≥n del Cliente</h6>
                            <ul class="list-unstyled">
                                <li><strong>Nombre:</strong> ${data.cliente_nombre}</li>
                                <li><strong>Tel√©fono:</strong> ${data.telefono}</li>
                                <li><strong>Facturas pendientes:</strong> ${data.facturas_pendientes}</li>
                                <li><strong>Total pendiente:</strong> $${data.total_pendiente.toFixed(2)}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-whatsapp"></i> Acci√≥n</h6>
                            <p>Se ha generado un enlace de WhatsApp con el mensaje personalizado.</p>
                            <button class="btn btn-success btn-lg w-100" onclick="window.open('${data.enlace_whatsapp}', '_blank')">
                                <i class="fas fa-whatsapp me-2"></i>Abrir WhatsApp
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6><i class="fas fa-envelope"></i> Vista Previa del Mensaje</h6>
                        <div class="border rounded p-3 bg-light">
                            <pre style="white-space: pre-wrap; font-family: inherit;">${data.mensaje}</pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-success" onclick="window.open('${data.enlace_whatsapp}', '_blank')">
                        <i class="fas fa-whatsapp me-2"></i>Abrir WhatsApp
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const modalInstance = new bootstrap.Modal(modal);
    modalInstance.show();
    
    // Limpiar modal cuando se cierre
    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

function mostrarModalWhatsAppCuentasPorCobrar(data) {
    console.log('üéØ Mostrando modal de cuentas por cobrar con datos:', data);
    
    // Validar datos requeridos
    if (!data.enlace_whatsapp) {
        console.error('‚ùå Falta enlace_whatsapp en los datos:', data);
        alert('Error: No se pudo generar el enlace de WhatsApp');
        return;
    }
    
    // Crear modal din√°micamente
    const modalHTML = `
        <div class="modal fade" id="whatsappModalCuentas" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fab fa-whatsapp me-2"></i>Recordatorio de Cuentas por Cobrar
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-check-circle me-2"></i>Recordatorio preparado exitosamente
                                </h6>
                                <p><strong>Cliente:</strong> ${data.cliente_nombre || 'N/A'}</p>
                                <p><strong>Tel√©fono:</strong> ${data.telefono || 'N/A'}</p>
                                <p><strong>Facturas pendientes:</strong> ${data.facturas_pendientes || 0}</p>
                                <p><strong>Total pendiente:</strong> $${data.total_pendiente || 0}</p>
                                <p><strong>Mensaje:</strong></p>
                                <div class="border rounded p-3 bg-light">
                                    <pre style="white-space: pre-wrap; font-size: 0.9em;">${data.mensaje || 'Mensaje no disponible'}</pre>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="mb-3">
                                    <i class="fab fa-whatsapp text-success" style="font-size: 4rem;"></i>
                                </div>
                                <p class="text-muted">Haz clic en el bot√≥n para abrir WhatsApp</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <a href="${data.enlace_whatsapp}" 
                           target="_blank" 
                           class="btn btn-success btn-lg">
                            <i class="fab fa-whatsapp me-2"></i>Abrir WhatsApp
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('whatsappModalCuentas'));
    modal.show();
    
    // Limpiar modal cuando se cierre
    document.getElementById('whatsappModalCuentas').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Funcionalidad para enviar informes de facturas pagadas por WhatsApp
function enviarInformeFacturasPagadas(clienteId, clienteNombre) {
    console.log('üîç Funci√≥n de informe llamada con:', { clienteId, clienteNombre });
    
    if (!clienteId) {
        alert('Error: No se pudo identificar al cliente');
        return;
    }
    
    // Obtener el filtro actual de la p√°gina
    const filtroActual = '{{ filtro }}';
    console.log('üéØ Filtro actual detectado:', filtroActual);
    
    // Adaptar el mensaje de confirmaci√≥n seg√∫n el filtro
    let mensajeConfirmacion = `¬øDeseas enviar un informe de facturas por WhatsApp a ${clienteNombre}?\n\n`;
    
    switch(filtroActual) {
        case 'por_cobrar':
            mensajeConfirmacion += `Este informe incluir√°:\n‚Ä¢ Facturas pendientes por cobrar\n‚Ä¢ Saldos pendientes\n‚Ä¢ Fechas de vencimiento`;
            break;
        case 'abonada':
            mensajeConfirmacion += `Este informe incluir√°:\n‚Ä¢ Facturas con abonos parciales\n‚Ä¢ Saldos pendientes\n‚Ä¢ Progreso de pagos`;
            break;
        case 'cobrada':
            mensajeConfirmacion += `Este informe incluir√°:\n‚Ä¢ Facturas completamente pagadas\n‚Ä¢ Total de pagos realizados\n‚Ä¢ Historial de cobranzas`;
            break;
        default: // 'todas'
            mensajeConfirmacion += `Este informe incluir√°:\n‚Ä¢ Todas las facturas del cliente\n‚Ä¢ Resumen completo de estados\n‚Ä¢ Balance general`;
    }
    
    // Confirmar env√≠o
    if (!confirm(mensajeConfirmacion)) {
        return;
    }
    
    // Mostrar indicador de carga
    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparando...';
    btn.disabled = true;
    
    try {
        console.log('üîç Iniciando generaci√≥n de informe para cliente:', clienteId);
        
        // Obtener datos del cliente desde el contexto de la p√°gina con validaci√≥n
        const clientes = {{ clientes|default({})|tojson }};
        console.log('üìä Datos de clientes cargados:', clientes);
        const cliente = clientes[clienteId] || {};
        console.log('üë§ Cliente encontrado:', cliente);
        
        // Generar informe en el frontend
        const telefonoRaw = String(cliente.telefono || '').trim();
        
        // Formatear tel√©fono simple
        let telefono = telefonoRaw.replace(/\D/g, '');
        if (telefono.startsWith('00')) telefono = telefono.slice(2);
        if (telefono.startsWith('0')) telefono = telefono.slice(1);
        if (!telefono.startsWith('58')) telefono = '58' + telefono;
        
        if (!telefono) {
            alert('El cliente no tiene tel√©fono registrado.');
            return;
        }
        
        // Obtener informaci√≥n de facturas del cliente desde el contexto con validaci√≥n
        const cuentasObj = {{ cuentas|default({})|tojson }};
        console.log('üìã Datos de cuentas cargados:', cuentasObj);
        const cuentasArr = Array.isArray(cuentasObj) ? cuentasObj : Object.values(cuentasObj || {});
        console.log('üìã Cuentas convertidas a array:', cuentasArr);
        const cuentasCliente = cuentasArr.filter(c => c && String(c.cliente_id) === String(clienteId));
        console.log('üéØ Cuentas filtradas para el cliente:', cuentasCliente);
        
        // Clasificar facturas por estado
        const facturasPorCobrar = cuentasCliente.filter(c => c.estado === 'por_cobrar');
        const facturasAbonadas = cuentasCliente.filter(c => c.estado === 'abonada');
        const facturasCobradas = cuentasCliente.filter(c => c.estado === 'cobrada');
        
        // Calcular totales por estado
        const totalPorCobrar = facturasPorCobrar.reduce((sum, c) => sum + (parseFloat(c.saldo_pendiente) || 0), 0);
        const totalAbonadas = facturasAbonadas.reduce((sum, c) => sum + (parseFloat(c.saldo_pendiente) || 0), 0);
        const totalCobradas = facturasCobradas.reduce((sum, c) => sum + (parseFloat(c.total_usd) || 0), 0);
        
        const totalFacturas = cuentasCliente.length;
        const totalFacturado = cuentasCliente.reduce((sum, c) => sum + (parseFloat(c.total_usd) || 0), 0);
        const totalAbonado = cuentasCliente.reduce((sum, c) => {
            const abonado = c.abonado_usd != null ? parseFloat(c.abonado_usd) : (parseFloat(c.total_usd) || 0) - (parseFloat(c.saldo_pendiente) || 0);
            return sum + (isNaN(abonado) ? 0 : abonado);
        }, 0);
        const totalPendiente = Math.max(totalFacturado - totalAbonado, 0);
        
        // Generar mensaje del informe inteligente adaptado al filtro
        let mensaje = `Hola ${clienteNombre}, aqu√≠ tienes tu informe de facturas (${filtroActual.toUpperCase()}):\n\n`;
        console.log('üìù Iniciando construcci√≥n del mensaje con filtro:', filtroActual);
        
        // Adaptar el resumen seg√∫n el filtro
        switch(filtroActual) {
            case 'por_cobrar':
                mensaje += `üìä RESUMEN DE FACTURAS PENDIENTES:\n`;
                mensaje += `‚Ä¢ Total de facturas pendientes: ${totalFacturas}\n`;
                mensaje += `‚Ä¢ Total pendiente por cobrar: $${totalPendiente.toFixed(2)} USD\n`;
                mensaje += `‚Ä¢ Promedio por factura: $${(totalPendiente / totalFacturas).toFixed(2)} USD\n\n`;
                break;
                
            case 'abonada':
                mensaje += `üìä RESUMEN DE FACTURAS CON ABONOS:\n`;
                mensaje += `‚Ä¢ Total de facturas abonadas: ${totalFacturas}\n`;
                mensaje += `‚Ä¢ Total abonado: $${totalAbonado.toFixed(2)} USD\n`;
                mensaje += `‚Ä¢ Saldo pendiente: $${totalPendiente.toFixed(2)} USD\n`;
                mensaje += `‚Ä¢ Progreso de recuperaci√≥n: ${((totalAbonado / totalFacturado) * 100).toFixed(1)}%\n\n`;
                break;
                
            case 'cobrada':
                mensaje += `üìä RESUMEN DE FACTURAS COBRADAS:\n`;
                mensaje += `‚Ä¢ Total de facturas cobradas: ${totalFacturas}\n`;
                mensaje += `‚Ä¢ Total cobrado: $${totalFacturado.toFixed(2)} USD\n`;
                mensaje += `‚Ä¢ Promedio por factura: $${(totalFacturado / totalFacturas).toFixed(2)} USD\n\n`;
                break;
                
            default: // 'todas'
                mensaje += `üìä RESUMEN GENERAL:\n`;
                mensaje += `‚Ä¢ Total de facturas: ${totalFacturas}\n`;
                mensaje += `‚Ä¢ Total facturado: $${totalFacturado.toFixed(2)} USD\n`;
                mensaje += `‚Ä¢ Total abonado: $${totalAbonado.toFixed(2)} USD\n`;
                mensaje += `‚Ä¢ Saldo pendiente: $${totalPendiente.toFixed(2)} USD\n\n`;
                mensaje += `üìã CLASIFICACI√ìN POR ESTADO:\n`;
                mensaje += `‚Ä¢ Facturas por cobrar: ${facturasPorCobrar.length} ($${totalPorCobrar.toFixed(2)} USD)\n`;
                mensaje += `‚Ä¢ Facturas abonadas: ${facturasAbonadas.length} ($${totalAbonadas.toFixed(2)} USD)\n`;
                mensaje += `‚Ä¢ Facturas cobradas: ${facturasCobradas.length} ($${totalCobradas.toFixed(2)} USD)\n\n`;
        }
        
        mensaje += `üìÖ DETALLE DE FACTURAS:\n`;
        
        // Agregar detalles seg√∫n el filtro seleccionado
        switch(filtroActual) {
            case 'por_cobrar':
                if (facturasPorCobrar.length > 0) {
                    mensaje += `\nüî¥ FACTURAS PENDIENTES POR COBRAR:\n`;
                    facturasPorCobrar.forEach(f => {
                        try {
                            const fecha = f.fecha || 'Sin fecha';
                            const vence = f.fecha_vencimiento ? ` (Vence: ${f.fecha_vencimiento})` : '';
                            const diasVencidos = f.dias_vencidos > 0 ? ` ‚ö†Ô∏è Vencida ${f.dias_vencidos} d√≠as` : '';
                            const saldo = parseFloat(f.saldo_pendiente) || 0;
                            mensaje += `‚Ä¢ ${f.numero || 'N/A'}: $${saldo.toFixed(2)} USD - ${fecha}${vence}${diasVencidos}\n`;
                        } catch (e) {
                            console.error('Error procesando factura por cobrar:', e, f);
                            mensaje += `‚Ä¢ Factura con error de datos\n`;
                        }
                    });
                }
                break;
                
            case 'abonada':
                if (facturasAbonadas.length > 0) {
                    mensaje += `\nüü° FACTURAS CON ABONOS PARCIALES:\n`;
                    facturasAbonadas.forEach(f => {
                        try {
                            const fecha = f.fecha || 'Sin fecha';
                            const abonado = parseFloat(f.abonado_usd) || 0;
                            const pendiente = parseFloat(f.saldo_pendiente) || 0;
                            const progreso = ((abonado / (abonado + pendiente)) * 100).toFixed(1);
                            mensaje += `‚Ä¢ ${f.numero || 'N/A'}: Abonado $${abonado.toFixed(2)} USD, Pendiente $${pendiente.toFixed(2)} USD (${progreso}% pagado) - ${fecha}\n`;
                        } catch (e) {
                            console.error('Error procesando factura abonada:', e, f);
                            mensaje += `‚Ä¢ Factura con error de datos\n`;
                        }
                    });
                }
                break;
                
            case 'cobrada':
                if (facturasCobradas.length > 0) {
                    mensaje += `\nüü¢ FACTURAS COMPLETAMENTE COBRADAS:\n`;
                    facturasCobradas.forEach(f => {
                        try {
                            const fecha = f.fecha || 'Sin fecha';
                            const total = parseFloat(f.total_usd) || 0;
                            mensaje += `‚Ä¢ ${f.numero || 'N/A'}: $${total.toFixed(2)} USD - ${fecha}\n`;
                        } catch (e) {
                            console.error('Error procesando factura cobrada:', e, f);
                            mensaje += `‚Ä¢ Factura con error de datos\n`;
                        }
                    });
                }
                break;
                
            default: // 'todas'
                // Agregar facturas por cobrar con fechas
                if (facturasPorCobrar.length > 0) {
                    mensaje += `\nüî¥ PENDIENTES POR COBRAR:\n`;
                    facturasPorCobrar.forEach(f => {
                        try {
                            const fecha = f.fecha || 'Sin fecha';
                            const vence = f.fecha_vencimiento ? ` (Vence: ${f.fecha_vencimiento})` : '';
                            const diasVencidos = f.dias_vencidos > 0 ? ` ‚ö†Ô∏è Vencida ${f.dias_vencidos} d√≠as` : '';
                            const saldo = parseFloat(f.saldo_pendiente) || 0;
                            mensaje += `‚Ä¢ ${f.numero || 'N/A'}: $${saldo.toFixed(2)} USD - ${fecha}${vence}${diasVencidos}\n`;
                        } catch (e) {
                            console.error('Error procesando factura por cobrar:', e, f);
                            mensaje += `‚Ä¢ Factura con error de datos\n`;
                        }
                    });
                }
                
                // Agregar facturas abonadas con fechas
                if (facturasAbonadas.length > 0) {
                    mensaje += `\nüü° CON ABONOS:\n`;
                    facturasAbonadas.forEach(f => {
                        try {
                            const fecha = f.fecha || 'Sin fecha';
                            const abonado = parseFloat(f.abonado_usd) || 0;
                            const pendiente = parseFloat(f.saldo_pendiente) || 0;
                            mensaje += `‚Ä¢ ${f.numero || 'N/A'}: Abonado $${abonado.toFixed(2)} USD, Pendiente $${pendiente.toFixed(2)} USD - ${fecha}\n`;
                        } catch (e) {
                            console.error('Error procesando factura abonada:', e, f);
                            mensaje += `‚Ä¢ Factura con error de datos\n`;
                        }
                    });
                }
                
                // Agregar facturas cobradas con fechas
                if (facturasCobradas.length > 0) {
                    mensaje += `\nüü¢ COMPLETAMENTE COBRADAS:\n`;
                    facturasCobradas.forEach(f => {
                        try {
                            const fecha = f.fecha || 'Sin fecha';
                            const total = parseFloat(f.total_usd) || 0;
                            mensaje += `‚Ä¢ ${f.numero || 'N/A'}: $${total.toFixed(2)} USD - ${fecha}\n`;
                        } catch (e) {
                            console.error('Error procesando factura cobrada:', e, f);
                            mensaje += `‚Ä¢ Factura con error de datos\n`;
                        }
                    });
                }
                break;
        }
        
        mensaje += `üí° Para coordinar pagos o resolver dudas, cont√°ctanos. Gracias.`;
        
        // Verificar que el mensaje se construy√≥ correctamente
        console.log('üì± Mensaje completo construido:', mensaje);
        console.log('üìè Longitud del mensaje:', mensaje.length);
        console.log('üîç Emojis detectados en el mensaje:', mensaje.match(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu));
        
        // Probar emojis espec√≠ficos
        console.log('üß™ Prueba de emojis espec√≠ficos:');
        console.log('üìä Bar Chart:', 'üìä');
        console.log('üìã Clipboard:', 'üìã');
        console.log('üìÖ Calendar:', 'üìÖ');
        console.log('üî¥ Red Circle:', 'üî¥');
        console.log('üü° Yellow Square:', 'üü°');
        console.log('üü¢ Green Square:', 'üü¢');
        console.log('‚ö†Ô∏è Warning:', '‚ö†Ô∏è');
        console.log('üí° Light Bulb:', 'üí°');
        
        // Verificar emojis en el mensaje generado
        console.log('üîç Verificando emojis en mensaje generado:');
        const emojisEnMensaje = mensaje.match(/[\u{1F600}-\u{1F64F}]|[\u{1F300}-\u{1F5FF}]|[\u{1F680}-\u{1F6FF}]|[\u{1F1E0}-\u{1F1FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu) || [];
        console.log('üìä Emojis encontrados en mensaje:', emojisEnMensaje);
        console.log('üìè Cantidad de emojis:', emojisEnMensaje.length);
        
        // Crear enlaces de WhatsApp con codificaci√≥n correcta
        const mensajeCodificado = encodeURIComponent(mensaje);
        console.log('üîó Mensaje codificado:', mensajeCodificado);
        
        // Verificar que la codificaci√≥n preserv√≥ los emojis
        const mensajeDecodificado = decodeURIComponent(mensajeCodificado);
        console.log('üîç Mensaje decodificado para verificaci√≥n:', mensajeDecodificado);
        console.log('‚úÖ Emojis preservados:', mensajeDecodificado.includes('üìä') && mensajeDecodificado.includes('üìÖ') && mensajeDecodificado.includes('üî¥'));
        
        // Crear enlaces con verificaci√≥n adicional
        const enlaceApp = `https://wa.me/${telefono}?text=${mensajeCodificado}`;
        const enlaceWeb = `https://web.whatsapp.com/send?phone=${telefono}&text=${mensajeCodificado}`;
        
        // Verificar enlaces generados
        console.log('üì± Enlace App:', enlaceApp);
        console.log('üíª Enlace Web:', enlaceWeb);
        console.log('üìû Tel√©fono formateado:', telefono);
        
        // Verificar que los enlaces contengan el mensaje codificado
        console.log('üîç Verificaci√≥n de enlaces:');
        console.log('üì± App contiene mensaje:', enlaceApp.includes(mensajeCodificado));
        console.log('üíª Web contiene mensaje:', enlaceWeb.includes(mensajeCodificado));
        
        // Mostrar modal con el informe
        mostrarModalInformeWhatsAppCuentasPorCobrar({
            success: true,
            cliente_nombre: clienteNombre,
            telefono: telefonoRaw || telefono,
            mensaje,
            enlace_whatsapp: enlaceApp,
            enlace_web: enlaceWeb,
            total_facturas: totalFacturas,
            total_facturado: totalFacturado,
            total_abonado: totalAbonado,
            total_pendiente: totalPendiente,
            facturas_por_cobrar: facturasPorCobrar.length,
            facturas_abonadas: facturasAbonadas.length,
            facturas_cobradas: facturasCobradas.length
        });
        
    } catch (e) {
        console.error('Error preparando informe en cliente:', e);
        alert('Error inesperado al preparar el informe en el navegador.');
    } finally {
        // Restaurar bot√≥n
        btn.innerHTML = originalContent;
        btn.disabled = false;
    }
}

function mostrarModalInformeWhatsAppCuentasPorCobrar(data) {
    console.log('üéØ Mostrando modal de informe con datos:', data);
    
    // Validar datos requeridos
    if (!data.enlace_whatsapp) {
        console.error('‚ùå Falta enlace_whatsapp en los datos:', data);
        alert('Error: No se pudo generar el enlace de WhatsApp');
        return;
    }
    
    // Crear modal din√°micamente
    const phoneDigits = String(data.telefono || '').replace(/\D/g, '');
    const enlaceApp = data.enlace_whatsapp;
    const enlaceWeb = data.enlace_web;
    
    console.log('üéØ Modal - Enlace App:', enlaceApp);
    console.log('üéØ Modal - Enlace Web:', enlaceWeb);
    console.log('üéØ Modal - Tel√©fono:', phoneDigits);
    
    const modalHTML = `
        <div class="modal fade" id="informeWhatsappModalCuentas" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-chart-line me-2"></i>Informe de Facturas Preparado para WhatsApp
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-check-circle me-2"></i>Informe preparado exitosamente
                                </h6>
                                <p><strong>Cliente:</strong> ${data.cliente_nombre || 'N/A'}</p>
                                <p><strong>Tel√©fono:</strong> ${data.telefono || 'N/A'}</p>
                                <p><strong>Total de facturas:</strong> ${data.total_facturas || 0}</p>
                                <p><strong>Total facturado:</strong> $${data.total_facturado || 0}</p>
                                <p><strong>Total abonado:</strong> $${data.total_abonado || 0}</p>
                                <p><strong>Saldo pendiente:</strong> $${data.total_pendiente || 0}</p>
                                <p><strong>Mensaje del informe:</strong></p>
                                <div class="border rounded p-3 bg-light">
                                    <pre style="white-space: pre-wrap; font-size: 0.9em;">${data.mensaje || 'Mensaje no disponible'}</pre>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="mb-3">
                                    <i class="fas fa-chart-line text-primary" style="font-size: 4rem;"></i>
                                </div>
                                <p class="text-muted">Haz clic en un bot√≥n para abrir WhatsApp</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-warning me-2" id="btnProbarEmojis">
                            <i class="fas fa-bug me-2"></i>Probar Emojis
                        </button>
                        <button type="button" class="btn btn-info me-2" id="btnCopiarMensaje">
                            <i class="fas fa-copy me-2"></i>Copiar Mensaje
                        </button>
                        <button type="button" class="btn btn-dark me-2" id="btnProbarEnlaces">
                            <i class="fas fa-link me-2"></i>Probar Enlaces
                        </button>
                        <a href="${enlaceWeb}" target="_blank" class="btn btn-success" onclick="console.log('üåê Abriendo WhatsApp Web:', '${enlaceWeb}')">
                            <i class="fab fa-whatsapp me-2"></i>Abrir WhatsApp Web
                        </a>
                        <a href="${enlaceApp}" target="_blank" class="btn btn-primary btn-lg" onclick="console.log('üì± Abriendo WhatsApp App:', '${enlaceApp}')">
                            <i class="fab fa-whatsapp me-2"></i>Abrir App
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Configurar event listeners para los botones
    const modalElement = document.getElementById('informeWhatsappModalCuentas');
    const btnProbarEmojis = modalElement.querySelector('#btnProbarEmojis');
    const btnCopiarMensaje = modalElement.querySelector('#btnCopiarMensaje');
    const btnProbarEnlaces = modalElement.querySelector('#btnProbarEnlaces');
    
    btnProbarEmojis.addEventListener('click', function() {
        probarEmojis(data.mensaje);
    });
    
    btnCopiarMensaje.addEventListener('click', function() {
        copiarMensajeAlPortapapeles(data.mensaje);
    });
    
    btnProbarEnlaces.addEventListener('click', function() {
        probarEnlaces(data.enlace_whatsapp, data.enlace_web, data.mensaje);
    });
    
    // Mostrar modal
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Limpiar modal cuando se cierre
    modalElement.addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Funci√≥n para copiar el mensaje al portapapeles
function copiarMensajeAlPortapapeles(mensaje) {
    try {
        // El mensaje ya viene decodificado, solo copiarlo
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(mensaje).then(() => {
                alert('‚úÖ Mensaje copiado al portapapeles con emojis');
                console.log('üìã Mensaje copiado:', mensaje);
            }).catch(err => {
                console.error('Error copiando al portapapeles:', err);
                fallbackCopyTextToClipboard(mensaje);
            });
        } else {
            fallbackCopyTextToClipboard(mensaje);
        }
    } catch (e) {
        console.error('Error procesando mensaje para copiar:', e);
        alert('‚ùå Error al copiar el mensaje');
    }
}

// Fallback para navegadores que no soportan clipboard API
function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        alert('‚úÖ Mensaje copiado al portapapeles');
        console.log('üìã Mensaje copiado (fallback):', text);
    } catch (err) {
        console.error('Error en fallback copy:', err);
        alert('‚ùå Error al copiar el mensaje');
    }
    
    document.body.removeChild(textArea);
}

// Funci√≥n para probar emojis
function probarEmojis(mensaje) {
    console.log('üß™ PROBANDO EMOJIS:');
    console.log('üìù Mensaje completo:', mensaje);
    console.log('üìè Longitud:', mensaje.length);
    
    // Verificar emojis espec√≠ficos
    const emojis = {
        'üìä': 'üìä',
        'üìã': 'üìã',
        'üìÖ': 'üìÖ',
        'üî¥': 'üî¥',
        'üü°': 'üü°',
        'üü¢': 'üü¢',
        '‚ö†Ô∏è': '‚ö†Ô∏è',
        'üí°': 'üí°'
    };
    
    console.log('üîç Emojis encontrados:');
    let emojisEncontrados = 0;
    Object.entries(emojis).forEach(([nombre, codigo]) => {
        const encontrado = mensaje.includes(codigo);
        console.log(`${nombre} (${codigo}): ${encontrado ? '‚úÖ' : '‚ùå'}`);
        if (encontrado) emojisEncontrados++;
    });
    
    console.log(`üìä Total emojis encontrados: ${emojisEncontrados}/${Object.keys(emojis).length}`);
    
    // Mostrar mensaje en alert para verificaci√≥n visual
    const mensajeFormateado = mensaje.replace(/\n/g, '\n');
    alert(`üß™ PRUEBA DE EMOJIS:\n\nMensaje generado:\n${mensajeFormateado}\n\nEmojis encontrados: ${emojisEncontrados}/${Object.keys(emojis).length}\n\nVerifica en la consola del navegador los detalles.`);
    
    // Tambi√©n mostrar en consola el mensaje formateado
    console.log('üìã Mensaje formateado para copiar:');
    console.log(mensaje);
}

// Funci√≥n para probar enlaces
function probarEnlaces(enlaceApp, enlaceWeb, mensaje) {
    console.log('üîó PROBANDO ENLACES:');
    console.log('üì± Enlace App:', enlaceApp);
    console.log('üíª Enlace Web:', enlaceWeb);
    console.log('üìù Mensaje original:', mensaje);
    
    // Verificar codificaci√≥n
    const mensajeCodificado = encodeURIComponent(mensaje);
    const mensajeDecodificado = decodeURIComponent(mensajeCodificado);
    
    console.log('üîç Codificaci√≥n:');
    console.log('üì§ Mensaje codificado:', mensajeCodificado);
    console.log('üì• Mensaje decodificado:', mensajeDecodificado);
    console.log('‚úÖ Emojis preservados:', mensajeDecodificado.includes('üìä') && mensajeDecodificado.includes('üìÖ') && mensajeDecodificado.includes('üî¥'));
    
    // Verificar enlaces
    console.log('üîç Verificaci√≥n de enlaces:');
    console.log('üì± App contiene mensaje codificado:', enlaceApp.includes(mensajeCodificado));
    console.log('üíª Web contiene mensaje codificado:', enlaceWeb.includes(mensajeCodificado));
    
    // Mostrar alert con informaci√≥n
    alert(`üîó PRUEBA DE ENLACES:\n\n` +
          `üì± Enlace App: ${enlaceApp.substring(0, 100)}...\n\n` +
          `üíª Enlace Web: ${enlaceWeb.substring(0, 100)}...\n\n` +
          `üìù Mensaje original: ${mensaje.substring(0, 200)}...\n\n` +
          `‚úÖ Emojis preservados: ${mensajeDecodificado.includes('üìä') && mensajeDecodificado.includes('üìÖ') && mensajeDecodificado.includes('üî¥') ? 'S√ç' : 'NO'}\n\n` +
          `Verifica en la consola del navegador los detalles completos.`);
}
</script>

{% endblock %} 