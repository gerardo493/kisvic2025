{% extends "base.html" %}

{% block title %}Factura #{{ factura.numero }} - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid my-4" id="factura-dashboard">
    <!-- Header con Logo y T√≠tulo -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" style="max-height: 60px; margin-right: 20px;">
                <div>
                    <h2 class="mb-1">{{ empresa.nombre }}</h2>
                    <p class="text-muted mb-0">RIF: {{ empresa.rif }} | {{ empresa.direccion }}</p>
                </div>
    </div>
        </div>
        <div class="col-md-4 text-end">
            <h3 class="text-primary mb-1">#{{ factura.numero }}</h3>
            <p class="text-muted mb-0">{{ factura.fecha }} {{ factura.hora or '' }}</p>
        </div>
    </div>

    <!-- Panel de Estado y Progreso -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">Estado de la Factura</h5>
            {% if factura.estado == 'cobrada' %}
                        <div class="badge bg-success fs-6 px-4 py-2 mb-3">‚úÖ COBRADA</div>
            {% elif factura.estado == 'abonada' %}
                        <div class="badge bg-info text-dark fs-6 px-4 py-2 mb-3">üí∞ ABONADA</div>
            {% else %}
                        <div class="badge bg-warning text-dark fs-6 px-4 py-2 mb-3">‚è≥ PENDIENTE</div>
            {% endif %}
                    
                    <div class="progress mb-2" style="height: 8px;">
                        {% set porcentaje_pago = ((factura.total_abonado / factura.total_usd) * 100) if factura.total_usd > 0 else 0 %}
                        <div class="progress-bar bg-success" role="progressbar" style="width: {{ porcentaje_pago }}%"></div>
                    </div>
                    <small class="text-muted">{{ "%.1f"|format(porcentaje_pago) }}% pagado</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">Informaci√≥n de Pago</h5>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary mb-1">${{ "%.2f"|format(factura.total_usd) }}</h4>
                            <small class="text-muted">Total USD</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-1">${{ "%.2f"|format(factura.total_abonado) }}</h4>
                            <small class="text-muted">Abonado</small>
                        </div>
                    </div>
                    <hr class="my-3">
                    <div class="d-flex justify-content-between">
                        <span class="text-muted">Saldo:</span>
                        <span class="fw-bold text-danger">${{ "%.2f"|format(factura.saldo_pendiente) }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">Condiciones</h5>
                    <div class="mb-2">
                        <span class="badge bg-secondary">{{ 'CR√âDITO' if factura.condicion_pago == 'credito' else 'CONTADO' }}</span>
                    </div>
                    {% if factura.condicion_pago == 'credito' and factura.fecha_vencimiento %}
                        <div class="mb-2">
                            <small class="text-muted d-block">Vence:</small>
                            <span class="fw-bold">{{ factura.fecha_vencimiento }}</span>
                        </div>
                        {% set dias_vencimiento = ((factura.fecha_vencimiento|string|strptime('%Y-%m-%d') - now().date()).days) %}
                        {% if dias_vencimiento > 0 %}
                            <div class="text-success">
                                <small>Faltan {{ dias_vencimiento }} d√≠as</small>
                            </div>
                        {% elif dias_vencimiento == 0 %}
                            <div class="text-warning">
                                <small>Vence hoy</small>
                            </div>
                        {% else %}
                            <div class="text-danger">
                                <small>Vencida hace {{ dias_vencimiento|abs }} d√≠as</small>
                            </div>
                {% endif %}
                {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones R√°pidas -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üöÄ Acciones R√°pidas</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2 col-6">
                            <a href="{{ url_for('imprimir_factura', id=factura.id) }}" target="_blank" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                                <i class="fas fa-print fa-2x mb-2"></i>
                                <span>Imprimir</span>
                            </a>
                        </div>
                        <div class="col-md-2 col-6">
                            <a href="{{ url_for('descargar_factura_pdf', id=factura.id) }}" class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                                <i class="fas fa-file-pdf fa-2x mb-2"></i>
                                <span>Descargar PDF</span>
                            </a>
                        </div>
                        <div class="col-md-2 col-6">
                            <a href="{{ url_for('editar_factura', id=factura.id) }}" class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                                <i class="fas fa-edit fa-2x mb-2"></i>
                                <span>Editar</span>
                            </a>
                        </div>
                        {% if factura.estado != 'cobrada' %}
                        <div class="col-md-2 col-6">
                            <a href="{{ url_for('registrar_pago', id=factura.id) }}" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                <span>Registrar Pago</span>
                            </a>
                        </div>
                        <div class="col-md-2 col-6">
                            <button class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center" onclick="enviarRecordatorioWhatsAppSimple()">
                                <i class="fab fa-whatsapp fa-2x mb-2"></i>
                                <span>Recordatorio WhatsApp</span>
                            </button>
                        </div>
                        {% endif %}
                        <div class="col-md-2 col-6">
                            <button class="btn btn-outline-secondary w-100 h-100 d-flex flex-column align-items-center justify-content-center" onclick="duplicarFactura()">
                                <i class="fas fa-copy fa-2x mb-2"></i>
                                <span>Duplicar</span>
                            </button>
                        </div>
                        <div class="col-md-2 col-6">
                            <button class="btn btn-outline-dark w-100 h-100 d-flex flex-column align-items-center justify-content-center" onclick="compartirFactura()">
                                <i class="fas fa-share-alt fa-2x mb-2"></i>
                                <span>Compartir</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n del Cliente y Productos -->
    <div class="row mb-4">
        <!-- Informaci√≥n del Cliente -->
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üë§ Informaci√≥n del Cliente</h5>
                </div>
                <div class="card-body">
                    {% set cliente = clientes[factura.cliente_id] %}
                    {% if cliente %}
                        <h6 class="fw-bold">{{ cliente.nombre }}</h6>
                        <p class="text-muted mb-2">RIF: {{ cliente.id }}</p>
                        <p class="mb-2"><i class="fas fa-map-marker-alt text-muted me-2"></i>{{ cliente.direccion }}</p>
                        <p class="mb-3"><i class="fas fa-phone text-muted me-2"></i>{{ cliente.telefono }}</p>
                        
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('historial_cliente', id=cliente.id) }}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-history me-2"></i>Ver Historial
                            </a>
                            <a href="{{ url_for('editar_cliente', id=cliente.id) }}" class="btn btn-sm btn-outline-warning">
                                <i class="fas fa-edit me-2"></i>Editar Cliente
                            </a>
            </div>
                    {% else %}
                        <p class="text-muted">Cliente no encontrado</p>
                    {% endif %}
        </div>
      </div>
    </div>

        <!-- Productos de la Factura -->
        <div class="col-md-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üì¶ Productos ({{ factura.productos|length }})</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                        <table class="table table-sm">
                    <thead>
                        <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cant.</th>
                                    <th class="text-end">Precio USD</th>
                                    <th class="text-end">Total USD</th>
                                    <th class="text-center">Stock</th>
                        </tr>
                    </thead>
                    <tbody>
                                {% for prod_id, cantidad in zip(factura.productos, factura.cantidades) %}
                                {% set producto = inventario[prod_id] %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="fw-bold">{{ producto.nombre if producto else prod_id }}</span>
                                            {% if producto and producto.categoria %}
                                                <span class="badge bg-light text-dark ms-2">{{ producto.categoria }}</span>
                                {% endif %}
                                        </div>
                            </td>
                                    <td class="text-center">{{ cantidad }}</td>
                                    <td class="text-end">${{ factura.precios[loop.index0]|es_number }}</td>
                                    <td class="text-end">${{ (factura.precios[loop.index0] * cantidad|int)|es_number }}</td>
                                    <td class="text-center">
                                        {% if producto %}
                                            {% set stock_actual = producto.stock or producto.cantidad or 0 %}
                                            {% if stock_actual < 10 %}
                                                <span class="badge bg-danger">{{ stock_actual }}</span>
                                            {% elif stock_actual < 50 %}
                                                <span class="badge bg-warning text-dark">{{ stock_actual }}</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ stock_actual }}</span>
                                {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        </div>
    </div>

    <!-- Totales y Tasa BCV -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üí∞ Resumen Financiero</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal USD:</span>
                                <span class="fw-bold">${{ factura.subtotal_usd|es_number }}</span>
                            </div>
                            {% if factura.descuento_total > 0 %}
                            <div class="d-flex justify-content-between mb-2">
                                <span>Descuento:</span>
                                <span class="fw-bold text-danger">-${{ factura.descuento_total|es_number }}</span>
                            </div>
                            {% endif %}
                            {% if factura.iva_total > 0 %}
                            <div class="d-flex justify-content-between mb-2">
                                <span>IVA ({{ factura.iva }}%):</span>
                                <span class="fw-bold">${{ factura.iva_total|es_number }}</span>
                            </div>
                            {% endif %}
                            <hr>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="h5 mb-0">Total USD:</span>
                                <span class="h5 mb-0 text-primary">${{ factura.total_usd|es_number }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center">
                                <h6 class="text-muted mb-2">Tasa BCV</h6>
                                <h3 class="text-success mb-2">{{ factura.tasa_bcv|es_number }} Bs/USD</h3>
                                <p class="text-muted mb-0">Total en Bol√≠vares:</p>
                                <h4 class="text-info">{{ factura.total_bs|es_number }} Bs</h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">üìä Estad√≠sticas</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="h4 text-primary mb-1">{{ factura.productos|length }}</div>
                        <small class="text-muted">Productos</small>
                    </div>
                    <div class="text-center mb-3">
                        <div class="h4 text-success mb-1">{{ factura.cantidades|sum }}</div>
                        <small class="text-muted">Unidades</small>
                    </div>
                    <div class="text-center">
                        <div class="h4 text-info mb-1">{{ "%.2f"|format(factura.total_usd / factura.cantidades|sum) if factura.cantidades|sum > 0 else 0 }}</div>
                        <small class="text-muted">Promedio por unidad</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Pagos -->
    {% if factura.pagos and factura.pagos|length > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üí≥ Historial de Pagos</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        {% for pago in factura.pagos %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Pago registrado</h6>
                                        <p class="text-muted mb-0">{{ pago.fecha if pago.fecha else 'Fecha no especificada' }}</p>
                                    </div>
                                    <div class="text-end">
                                        <span class="h5 text-success mb-0">${{ pago.monto|es_number }}</span>
                                        {% if pago.metodo %}
                                        <br><small class="text-muted">{{ pago.metodo }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if pago.observaciones %}
                                <p class="text-muted mt-2 mb-0"><em>{{ pago.observaciones }}</em></p>
    {% endif %}
</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Notas y Comentarios -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìä Detalles de la Factura</h5>
                </div>
                <div class="card-body">
                    <!-- Informaci√≥n de la Factura -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="form-label fw-bold text-muted">N√∫mero:</label>
                                <p class="h5 text-primary">{{ factura.numero }}</p>
                            </div>
                            <div class="info-item">
                                <label class="form-label fw-bold text-muted">Fecha:</label>
                                <p class="h5">{{ factura.fecha }}</p>
                            </div>
                            <div class="info-item">
                                <label class="form-label fw-bold text-muted">Hora:</label>
                                <p class="h5">{{ factura.hora or 'No especificada' }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item">
                                <label class="form-label fw-bold text-muted">Condici√≥n de Pago:</label>
                                <p class="h5">
                                    <span class="badge bg-{{ 'success' if factura.condicion_pago == 'contado' else 'warning' }}">
                                        {{ 'CONTADO' if factura.condicion_pago == 'contado' else 'CR√âDITO' }}
                                    </span>
                                </p>
                            </div>
                            {% if factura.condicion_pago == 'credito' and factura.fecha_vencimiento %}
                            <div class="info-item">
                                <label class="form-label fw-bold text-muted">Fecha de Vencimiento:</label>
                                <p class="h5 text-{{ 'success' if (factura.fecha_vencimiento|string|strptime('%Y-%m-%d') - now().date()).days > 0 else 'danger' }}">
                                    {{ factura.fecha_vencimiento }}
                                </p>
                            </div>
                            {% endif %}
                            <div class="info-item">
                                <label class="form-label fw-bold text-muted">Estado:</label>
                                <p class="h5">
                                    {% if factura.estado == 'cobrada' %}
                                        <span class="badge bg-success fs-6">‚úÖ COBRADA</span>
                                    {% elif factura.estado == 'abonada' %}
                                        <span class="badge bg-info text-dark fs-6">üí∞ ABONADA</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark fs-6">‚è≥ PENDIENTE</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Sistema de Recordatorios WhatsApp - SOLO ENV√çO DIRECTO -->
                    {% if factura.estado != 'cobrada' %}
                    <div class="alert alert-info border-0 shadow-sm">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-bell text-primary me-2 fa-lg"></i>
                            <h6 class="mb-0 fw-bold">üîî Sistema de Recordatorios WhatsApp - ENV√çO DIRECTO</h6>
                        </div>
                        <p class="mb-3">Env√≠a recordatorios de pago directamente por WhatsApp.</p>
                        
                        <div class="row g-3">
                            <div class="col-md-8">
                                <button class="btn btn-warning w-100" onclick="enviarRecordatorioDirecto()">
                                    <i class="fab fa-whatsapp me-2"></i>
                                    Enviar Recordatorio WhatsApp
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-secondary w-100" onclick="verHistorialRecordatorios()">
                                    <i class="fas fa-history me-2"></i>
                                    Ver Historial
                                </button>
                            </div>
                        </div>
                        
                        <!-- Indicador de Estado Simplificado -->
                        <div class="mt-3">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm text-success me-2" role="status" id="statusSpinner" style="display: none;">
                                    <span class="visually-hidden">Enviando...</span>
                                </div>
                                <small class="text-muted" id="statusText">Listo para enviar recordatorios</small>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Comentarios Adicionales -->
                    <div class="alert alert-light border-0 shadow-sm">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-comment text-secondary me-2 fa-lg"></i>
                            <h6 class="mb-0 fw-bold">üí¨ Comentarios Adicionales</h6>
                        </div>
                        <p class="mb-3">Informaci√≥n adicional y notas sobre esta factura.</p>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="form-label fw-bold">Observaciones:</label>
                                    <p class="text-muted">{{ factura.observaciones or 'Sin observaciones' }}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="form-label fw-bold">Notas del Cliente:</label>
                                    <p class="text-muted">{{ factura.notas_cliente or 'Sin notas del cliente' }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilos para Timeline -->
<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -35px;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 0 0 3px #dee2e6;
}

.timeline-item:not(:last-child)::after {
    content: '';
    position: absolute;
    left: -29px;
    top: 12px;
    width: 2px;
    height: calc(100% + 8px);
    background-color: #dee2e6;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #28a745;
}

/* Estilos para el sistema modernizado */
.info-item {
    margin-bottom: 1.5rem;
}

.info-item label {
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
}

.info-item p {
    margin-bottom: 0;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 0.375rem;
    border-left: 3px solid #007bff;
}

.alert-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: none;
    border-radius: 0.75rem;
}

.btn {
    border-radius: 0.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.card {
    border-radius: 0.75rem;
    overflow: hidden;
}

.shadow-sm {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
}

/* Animaciones para los botones de recordatorio */
.btn-warning {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    border: none;
    color: #212529;
}

.btn-info {
    background: linear-gradient(135deg, #17a2b8 0%, #0dcaf0 100%);
    border: none;
    color: white;
}

.btn-secondary {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border: none;
    color: white;
}

/* Estilos para el informe de facturas */
.bg-light {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
}

.rounded {
    border-radius: 0.5rem !important;
}

/* Responsive */
@media (max-width: 768px) {
    .col-md-3 {
        margin-bottom: 1rem;
    }
    
    .btn {
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
    }
}
</style>

<!-- JavaScript para funcionalidades -->
<script>
function duplicarFactura() {
    if (confirm('¬øDeseas duplicar esta factura?')) {
        mostrarNotificacion('üìã Duplicando factura...', 'info');
        
        // Aqu√≠ ir√≠a la l√≥gica para duplicar la factura
        setTimeout(() => {
            mostrarNotificacion('‚úÖ Factura duplicada correctamente', 'success');
        }, 1000);
    }
}

function compartirFactura() {
    if (confirm('¬øDeseas compartir esta factura?')) {
        mostrarNotificacion('üì§ Preparando factura para compartir...', 'info');
        
        // Aqu√≠ ir√≠a la l√≥gica para compartir la factura
        setTimeout(() => {
            mostrarNotificacion('‚úÖ Factura preparada para compartir', 'success');
        }, 1000);
    }
}

function guardarComentarios() {
    const comentarios = document.getElementById('comentarios').value;
    // Implementar guardado de comentarios
    alert('Comentarios guardados: ' + comentarios);
}

// ===== SISTEMA DE RECORDATORIOS WHATSAPP FUNCIONAMIENTO DIRECTO =====

// Variables globales del sistema
let sistemaRecordatorios = {
    estado: 'listo',
    historial: [],
    recordatoriosProgramados: []
};

// Funci√≥n principal para enviar recordatorios - ENV√çO DIRECTO SIN PREPARAR
function enviarRecordatorioDirecto() {
    console.log('üöÄ Enviando recordatorio directo para factura:', '{{ factura.id }}');
    
    // Mostrar indicador de env√≠o inmediato
    actualizarEstadoSistema('enviando', 'üì± Enviando recordatorio...');
    
    // Llamar directamente a la API
    fetch(`/facturas/{{ factura.id }}/enviar_recordatorio_whatsapp`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            factura_id: '{{ factura.id }}',
            tipo: 'recordatorio_pago'
        })
    })
    .then(response => {
        console.log('üì° Respuesta del servidor:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä Datos recibidos:', data);
        
        if (data.success) {
            // Registrar en el historial local
            registrarEnHistorial({
                tipo: 'recordatorio_enviado',
                fecha: new Date().toISOString(),
                factura_id: '{{ factura.id }}',
                cliente: data.cliente_nombre,
                telefono: data.telefono,
                mensaje: data.mensaje
            });
            
            actualizarEstadoSistema('exito', '‚úÖ Recordatorio enviado exitosamente');
            mostrarNotificacion('‚úÖ Recordatorio enviado exitosamente', 'success');
            
            // Mostrar modal simple con enlace directo a WhatsApp
            mostrarModalExitosoSimple(data);
        } else {
            console.error('‚ùå Error en la respuesta:', data);
            actualizarEstadoSistema('error', '‚ùå Error al enviar recordatorio');
            mostrarNotificacion(`‚ùå Error: ${data.error || 'No se pudo enviar el recordatorio'}`, 'danger');
        }
    })
    .catch(error => {
        console.error('‚ùå Error en la petici√≥n:', error);
        actualizarEstadoSistema('error', '‚ùå Error de conexi√≥n');
        mostrarNotificacion(`‚ùå Error de conexi√≥n: ${error.message}`, 'danger');
    });
}

// Funci√≥n para actualizar el estado del sistema
function actualizarEstadoSistema(estado, mensaje) {
    const spinner = document.getElementById('statusSpinner');
    const statusText = document.getElementById('statusText');
    
    sistemaRecordatorios.estado = estado;
    
    switch(estado) {
        case 'enviando':
            spinner.style.display = 'inline-block';
            statusText.textContent = mensaje;
            statusText.className = 'text-info';
            break;
        case 'exito':
            spinner.style.display = 'none';
            statusText.textContent = mensaje;
            statusText.className = 'text-success';
            break;
        case 'error':
            spinner.style.display = 'none';
            statusText.textContent = mensaje;
            statusText.className = 'text-danger';
            break;
        default:
            spinner.style.display = 'none';
            statusText.textContent = mensaje;
            statusText.className = 'text-muted';
    }
}

// Funci√≥n para registrar en el historial local
function registrarEnHistorial(recordatorio) {
    sistemaRecordatorios.historial.push(recordatorio);
    
    // Guardar en localStorage
    try {
        localStorage.setItem('recordatorios_historial', JSON.stringify(sistemaRecordatorios.historial));
    } catch (e) {
        console.warn('No se pudo guardar en localStorage:', e);
    }
}

// Funci√≥n para cargar historial desde localStorage
function cargarHistorial() {
    try {
        const historialGuardado = localStorage.getItem('recordatorios_historial');
        if (historialGuardado) {
            sistemaRecordatorios.historial = JSON.parse(historialGuardado);
        }
    } catch (e) {
        console.warn('No se pudo cargar historial:', e);
    }
}

// Funci√≥n para mostrar modal de recordatorio exitoso
function mostrarModalRecordatorioExitoso(data) {
    const modal = `
        <div class="modal fade" id="modalRecordatorioExitoso" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fab fa-whatsapp me-2"></i>Recordatorio Preparado para WhatsApp
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Recordatorio preparado exitosamente</strong>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Cliente:</label>
                                <p>{{ factura.cliente_id }}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Factura:</label>
                                <p>{{ factura.numero }}</p>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Saldo Pendiente:</label>
                                <p class="text-danger fw-bold">${{ factura.saldo_pendiente|es_number }}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Fecha de Vencimiento:</label>
                                <p>{{ factura.fecha_vencimiento or 'No especificada' }}</p>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Pr√≥ximos pasos:</strong>
                            <ul class="mb-0 mt-2">
                                <li>El mensaje est√° preparado en WhatsApp</li>
                                <li>Revisa y personaliza el mensaje si es necesario</li>
                                <li>Env√≠a el recordatorio al cliente</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-success" onclick="abrirWhatsApp()">
                            <i class="fab fa-whatsapp me-2"></i>Abrir WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    
    const modalElement = new bootstrap.Modal(document.getElementById('modalRecordatorioExitoso'));
    modalElement.show();
    
    // Limpiar modal al cerrar
    document.getElementById('modalRecordatorioExitoso').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Funci√≥n para mostrar modal de error
function mostrarModalError(error) {
    const modal = `
        <div class="modal fade" id="modalError" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error en el Sistema
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Se produjo un error al enviar el recordatorio</strong>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tipo de Error:</label>
                                <p class="text-danger">${error.name || 'Error de conexi√≥n'}</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Mensaje:</label>
                                <p class="text-danger">${error.message || 'Sin mensaje espec√≠fico'}</p>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Informaci√≥n de Debug:</label>
                            <div class="bg-light p-3 rounded">
                                <small class="text-muted">
                                    <strong>Factura ID:</strong> {{ factura.id }}<br>
                                    <strong>Cliente ID:</strong> {{ factura.cliente_id }}<br>
                                    <strong>URL de la API:</strong> /facturas/{{ factura.id }}/enviar_recordatorio_whatsapp<br>
                                    <strong>M√©todo:</strong> POST
                                </small>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Pasos para resolver:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Verifica que la consola del navegador no muestre errores</li>
                                <li>Confirma que el servidor est√© funcionando</li>
                                <li>Verifica que la factura y cliente existan</li>
                                <li>Contacta al administrador si el problema persiste</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-info" onclick="probarRecordatorio()">
                            <i class="fas fa-bug me-2"></i>Probar Sistema
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    
    const modalElement = new bootstrap.Modal(document.getElementById('modalError'));
    modalElement.show();
    
    // Limpiar modal al cerrar
    document.getElementById('modalError').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Funci√≥n para probar recordatorio
function probarRecordatorio() {
    console.log('üß™ Probando sistema de recordatorio...');
    
    // Abrir la ruta de debug en una nueva pesta√±a
    window.open(`/debug-recordatorio/{{ factura.id }}`, '_blank');
    
    mostrarNotificacion('üîç Abriendo p√°gina de debug en nueva pesta√±a', 'info');
}

// ===== FUNCIONES DEL SISTEMA DE RECORDATORIOS =====

// Funci√≥n para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'info') {
    const notificacion = `
        <div class="alert alert-${tipo} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : tipo === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', notificacion);
    
    // Auto-ocultar despu√©s de 5 segundos
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// Funci√≥n para enviar recordatorio WhatsApp - SIMPLE Y DIRECTO
function enviarRecordatorioWhatsAppSimple() {
    console.log('üöÄ Enviando recordatorio WhatsApp para factura:', '{{ factura.id }}');
    
    // Llamar directamente a la API
    fetch(`/facturas/{{ factura.id }}/enviar_recordatorio_whatsapp`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            factura_id: '{{ factura.id }}',
            tipo: 'recordatorio_pago'
        })
    })
    .then(response => {
        console.log('üì° Respuesta del servidor:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üìä Datos recibidos:', data);
        
        if (data.success) {
            // Mostrar modal de WhatsApp exitoso
            mostrarModalWhatsAppExitoso(data);
        } else {
            console.error('‚ùå Error en la respuesta:', data);
            alert(`Error: ${data.error || 'No se pudo enviar el recordatorio'}`);
        }
    })
    .catch(error => {
        console.error('‚ùå Error en la petici√≥n:', error);
        alert(`Error de conexi√≥n: ${error.message}`);
    });
}

// Funci√≥n para mostrar modal de WhatsApp exitoso
function mostrarModalWhatsAppExitoso(data) {
    const modal = `
        <div class="modal fade" id="modalWhatsAppExitoso" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fab fa-whatsapp me-2"></i>Recordatorio Preparado para WhatsApp
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="text-success mb-3">
                                    <i class="fas fa-check-circle me-2"></i>Recordatorio preparado exitosamente
                                </h6>
                                <p><strong>Cliente:</strong> ${data.cliente_nombre || '{{ factura.cliente_nombre or "Cliente" }}'}</p>
                                <p><strong>Tel√©fono:</strong> ${data.telefono || 'N/A'}</p>
                                <p><strong>Factura:</strong> {{ factura.numero }}</p>
                                <p><strong>Saldo pendiente:</strong> ${{ "%.2f"|format(factura.saldo_pendiente) }}</p>
                                <p><strong>Mensaje:</strong></p>
                                <div class="border rounded p-3 bg-light">
                                    <pre style="white-space: pre-wrap; font-size: 0.9em;">${data.mensaje || 'Mensaje no disponible'}</pre>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="mb-3">
                                    <i class="fab fa-whatsapp text-success" style="font-size: 4rem;"></i>
                                </div>
                                <p class="text-muted">Haz clic en el bot√≥n para abrir WhatsApp</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <a href="${data.enlace_whatsapp}" 
                           target="_blank" 
                           class="btn btn-success btn-lg">
                            <i class="fab fa-whatsapp me-2"></i>Abrir WhatsApp
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Agregar modal al DOM
    document.body.insertAdjacentHTML('beforeend', modal);
    
    // Mostrar modal
    const modalElement = new bootstrap.Modal(document.getElementById('modalWhatsAppExitoso'));
    modalElement.show();
    
    // Limpiar modal al cerrar
    document.getElementById('modalWhatsAppExitoso').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// ===== FUNCIONES ADICIONALES =====

// Funci√≥n para duplicar factura
function duplicarFactura() {
    if (confirm('¬øDeseas duplicar esta factura?')) {
        mostrarNotificacion('üìã Duplicando factura...', 'info');
        
        // Aqu√≠ ir√≠a la l√≥gica para duplicar la factura
        setTimeout(() => {
            mostrarNotificacion('‚úÖ Factura duplicada correctamente', 'success');
        }, 1000);
    }
}

// Funci√≥n para compartir factura
function compartirFactura() {
    if (confirm('¬øDeseas compartir esta factura?')) {
        mostrarNotificacion('üì§ Preparando factura para compartir...', 'info');
        
        // Aqu√≠ ir√≠a la l√≥gica para compartir la factura
        setTimeout(() => {
            mostrarNotificacion('‚úÖ Factura preparada para compartir', 'success');
        }, 1000);
    }
}

// ===== INICIALIZACI√ìN DEL SISTEMA =====

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sistema de Recordatorios WhatsApp - FUNCIONAMIENTO DIRECTO');
    
    // Cargar historial guardado
    cargarHistorial();
    
    // Verificar estado del sistema
    verificarEstadoSistema();
    
    // Agregar efectos hover a las tarjetas
    document.querySelectorAll('.card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'transform 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
});

// Funci√≥n para verificar estado del sistema
function verificarEstadoSistema() {
    // Simular verificaci√≥n del sistema
    setTimeout(() => {
        actualizarEstadoSistema('listo', '‚úÖ Sistema verificado y listo para usar');
    }, 1000);
}

// Funci√≥n para ver historial de recordatorios
function verHistorialRecordatorios() {
    // Mostrar modal con historial simplificado
    mostrarModalHistorial();
}

// Funci√≥n para mostrar modal de historial simplificado
function mostrarModalHistorial() {
    // Cargar historial antes de mostrar
    cargarHistorial();
    
    const modal = `
        <div class="modal fade" id="modalHistorial" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-secondary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-history me-2"></i>Historial de Recordatorios
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <h6>Recordatorios Enviados</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Cliente</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="historialTable">
                                        ${generarFilasHistorial()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-warning" onclick="limpiarHistorial()">
                            <i class="fas fa-trash me-2"></i>Limpiar Historial
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    
    const modalElement = new bootstrap.Modal(document.getElementById('modalHistorial'));
    modalElement.show();
    
    // Limpiar modal al cerrar
    document.getElementById('modalHistorial').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// Funci√≥n para generar filas del historial
function generarFilasHistorial() {
    if (sistemaRecordatorios.historial.length === 0) {
        return '<tr><td colspan="3" class="text-center text-muted">No hay recordatorios enviados</td></tr>';
    }
    
    return sistemaRecordatorios.historial
        .slice(-5) // Solo los √∫ltimos 5
        .map(recordatorio => `
            <tr>
                <td>${new Date(recordatorio.fecha).toLocaleDateString()}</td>
                <td>${recordatorio.cliente}</td>
                <td><span class="badge bg-success">Enviado</span></td>
            </tr>
        `).join('');
}

// Funci√≥n para limpiar historial
function limpiarHistorial() {
    if (confirm('¬øEst√°s seguro de que deseas limpiar todo el historial?')) {
        sistemaRecordatorios.historial = [];
        
        try {
            localStorage.removeItem('recordatorios_historial');
        } catch (e) {
            console.warn('No se pudo limpiar localStorage:', e);
        }
        
        mostrarNotificacion('üóëÔ∏è Historial limpiado exitosamente', 'success');
        
        // Cerrar modal
        bootstrap.Modal.getInstance(document.getElementById('modalHistorial')).hide();
    }
}

// Funci√≥n para abrir WhatsApp
function abrirWhatsApp() {
    // Abrir WhatsApp Web o la app
    window.open('https://web.whatsapp.com', '_blank');
    mostrarNotificacion('üì± WhatsApp abierto en nueva pesta√±a', 'info');
}

// Funci√≥n para mostrar modal exitoso simplificado
function mostrarModalExitosoSimple(data) {
    const modal = `
        <div class="modal fade" id="modalExitosoSimple" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fab fa-whatsapp me-2"></i>Recordatorio Enviado
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Recordatorio enviado exitosamente</strong>
                        </div>
                        
                        <p><strong>Cliente:</strong> ${data.cliente_nombre}</p>
                        <p><strong>Factura:</strong> {{ factura.numero }}</p>
                        <p><strong>Saldo:</strong> ${{ factura.saldo_pendiente|es_number }}</p>
                        
                        <div class="mt-3">
                            <a href="${data.enlace_whatsapp}" target="_blank" class="btn btn-success btn-lg">
                                <i class="fab fa-whatsapp me-2"></i>Abrir WhatsApp
                            </a>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    
    const modalElement = new bootstrap.Modal(document.getElementById('modalExitosoSimple'));
    modalElement.show();
    
    // Limpiar modal al cerrar
    document.getElementById('modalExitosoSimple').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}
</script>
{% endblock %}
