<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Cotización #{{ cotizacion.numero_cotizacion }}</title>
    <style>
        @page { size: A4; margin: 15mm 12mm 12mm 12mm; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Helvetica Neue', 'Arial', sans-serif; font-size: 11px; line-height: 1.4; color: #2c3e50; background: #ffffff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .watermark { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); width: 60%; height: 60%; z-index: -1; opacity: 0.02; display: flex; align-items: center; justify-content: center; }
        .watermark-content img { width: 100%; height: 100%; object-fit: contain; opacity: 0.8; }
        .factura-content { max-width: 180mm; margin: 0 auto; background: #ffffff; }
        .header { background: #ffffff; color: #2c3e50; padding: 18px 30px 14px 30px; border-bottom: 3px solid #0d6efd; }
        .header-row { display: flex; align-items: center; justify-content: center; gap: 20px; text-align: center; }
        .logo-col img { width: 110px; height: 110px; object-fit: contain; }
        .empresa-col { font-weight: 800; font-size: 16px; color: #0b2e57; }
        .document-title { text-align: center; background: #f8fbff; color: #0d6efd; padding: 10px 14px; font-size: 16px; font-weight: 800; text-transform: uppercase; letter-spacing: 3px; border: 2px solid #0d6efd; border-radius: 8px; margin: 10px 18px; }
        .content-section { padding: 18px 30px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 20px; }
        .info-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; padding: 14px; border-left: 5px solid #667eea; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0 18px 0; }
        thead th { background: #e9f2ff; color: #0b2e57; padding: 10px; font-size: 11px; font-weight: 800; text-transform: uppercase; border-bottom: 2px solid #0d6efd; }
        tbody td { padding: 10px; font-size: 11px; border-bottom: 1px solid #e9ecef; }
        .text-end { text-align: right; }
        .totals-section { background: #f8f9fa; border-radius: 12px; padding: 14px; }
        .totals-compact { max-width: 70mm; margin-left: auto; border: 1px solid #ced4da; border-radius: 8px; background: #ffffff; }
        .totals-compact .row { display: grid; grid-template-columns: 1fr auto; gap: 12px; padding: 8px 12px; border-bottom: 1px solid #eef1f4; font-size: 11px; }
        .totals-compact .row:last-child { border-bottom: 0; }
        .totals-compact .label { color: #6c757d; font-weight: 600; }
        .totals-compact .value { text-align: right; font-weight: 700; }
        .exchange-rate { text-align: center; margin-top: 10px; padding: 8px; background: #f8fbff; border-radius: 8px; border: 1px solid #b6d4fe; }
        .notes { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 12px; padding: 12px; margin-top: 14px; border-left: 5px solid #2196f3; font-size: 10px; }
        @media print { .header { background: #ffffff !important; } }
    </style>
</head>
<body>
    <div class="watermark">
        <div class="watermark-content">
            <img src="{{ url_for('static', filename=empresa.logo) if empresa.logo else url_for('static', filename='logo.png') }}" alt="Logo">
        </div>
    </div>
    <div class="factura-content">
        <div class="header">
        <div class="header-row">
            <div class="logo-col">
                <img src="{{ url_for('static', filename=empresa.logo) if empresa.logo else url_for('static', filename='logo.png') }}">
            </div>
            <div class="empresa-col">
                {{ empresa.nombre if empresa.nombre else 'EMPRESA' }}<br>
                {{ empresa.direccion if empresa.direccion else '' }}<br>
                Tel: {{ empresa.telefono if empresa.telefono else '' }} | RIF: {{ empresa.rif if empresa.rif else '' }}
            </div>
        </div>
        </div>
        <div class="document-title">COTIZACIÓN</div>
        <div class="content-section">
        <div class="info-grid">
            <div class="info-card">
                <div><strong>Cliente:</strong> {{ cotizacion.cliente.nombre if cotizacion.cliente.nombre else '' }}</div>
                <div><strong>RIF:</strong> {{ cotizacion.cliente.rif if cotizacion.cliente.rif else cotizacion.cliente.id if cotizacion.cliente.id else '' }}</div>
                <div><strong>Dirección:</strong> {{ cotizacion.cliente.direccion if cotizacion.cliente.direccion else '' }}</div>
                <div><strong>Teléfono:</strong> {{ cotizacion.cliente.telefono if cotizacion.cliente.telefono else '' }}</div>
                <div><strong>Validez:</strong> {{ cotizacion.validez_dias }} días</div>
            </div>
            <div class="info-card">
                <div><strong>Número:</strong> {{ cotizacion.numero_cotizacion }}</div>
                <div><strong>Fecha:</strong> {{ cotizacion.fecha }}</div>
                {% if cotizacion.hora %}<div><strong>Hora:</strong> {{ cotizacion.hora }}</div>{% endif %}
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Cant.</th>
                    <th>Descripción</th>
                    <th>P. Unit USD</th>
                    <th>P. Unit Bs</th>
                    <th>Subtotal Bs</th>
                    <th>Subtotal USD</th>
                </tr>
            </thead>
            <tbody>
                {% for prod_id, cantidad in zip(cotizacion.productos, cotizacion.cantidades) %}
                {% set precio = cotizacion.precios[loop.index0]|default(0)|float %}
                {% set cant = cantidad|default(0)|int %}
                {% set tasa = cotizacion.tasa_bcv|default(0)|float %}
                {% set subtotal_usd = precio * cant %}
                {% set subtotal_bs = subtotal_usd * tasa %}
                <tr>
                    <td style="border: 2px solid #bfa43a; text-align: right;">{{ cant }}</td>
                    <td style="border: 2px solid #bfa43a;">{{ inventario[prod_id].nombre if prod_id in inventario else prod_id }}</td>
                    <td style="border: 2px solid #bfa43a; text-align: right;">{{ precio|es_number }}</td>
                    <td style="border: 2px solid #bfa43a; text-align: right;">{{ (precio * tasa)|es_number }}</td>
                    <td style="border: 2px solid #bfa43a; text-align: right;">{{ subtotal_bs|es_number }}</td>
                    <td style="border: 2px solid #bfa43a; text-align: right;">{{ subtotal_usd|es_number }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="totals-section">
            <div class="totals-compact">
                <div class="row"><div class="label">Total Exento:</div><div class="value">Bs {{ total_bs|es_number }}</div></div>
                {% if cotizacion.iva_total|default(0)|float > 0 %}
                <div class="row"><div class="label">IVA ({{ cotizacion.iva|default(0) }}%):</div><div class="value">Bs {{ (cotizacion.iva_total|default(0)|float * cotizacion.tasa_bcv|default(0)|float)|es_number }}</div></div>
                {% endif %}
                {% if cotizacion.descuento_total|default(0)|float > 0 %}
                <div class="row"><div class="label">Descuento:</div><div class="value">Bs {{ (cotizacion.descuento_total|default(0)|float * cotizacion.tasa_bcv|default(0)|float)|es_number }}</div></div>
                {% endif %}
                <div class="row"><div class="label">USD:</div><div class="value">${{ total_usd|es_number }}</div></div>
            </div>
            <div class="exchange-rate">Tasa de cambio utilizada: {{ cotizacion.tasa_bcv|default(0)|float|es_number }} Bs/USD</div>
        </div>
        <div class="notes">
            • Documento calculado a la tasa de cambio BCV vigente a la fecha de emisión. Si la cotización se convierte en factura, se aplicará la tasa activa BCV a la fecha de pago. • Esta cotización no constituye documento fiscal.
        </div>
        </div>
    </div>
</body>
</html>
