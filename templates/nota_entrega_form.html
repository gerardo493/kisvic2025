{% extends "base.html" %}

{% block title %}{{ 'Editar' if nota else 'Nueva' }} Nota de Entrega{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-2">
                        <i class="fas fa-{% if nota %}edit{% else %}plus-circle{% endif %} me-3 text-primary"></i>
                        {{ 'Editar' if nota else 'Nueva' }} Nota de Entrega
                    </h1>
                    <p class="text-muted mb-0">
                        {% if nota %}
                            Editando nota {{ nota.numero }} para {{ nota.cliente_nombre }}
                        {% else %}
                            Crea una nueva nota de entrega con las tres modalidades de pago disponibles
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('mostrar_notas_entrega') }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form method="POST" id="notaForm">
        <!-- Token CSRF para protección -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        
        <div class="row">
            <!-- Columna izquierda - Información principal -->
            <div class="col-lg-8">
                <!-- Información del cliente y fecha -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user me-2"></i>Información del Cliente
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user me-1"></i>Cliente *
                                </label>
                                <select name="cliente_id" class="form-select form-select-lg" required>
                                    <option value="">Seleccionar cliente...</option>
                                    {% for cliente_id, cliente in clientes.items() %}
                                    <option value="{{ cliente_id }}" 
                                            {% if nota and nota.cliente_id == cliente_id %}selected{% endif %}>
                                        {{ cliente.nombre }} - {{ cliente.identificacion }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar me-1"></i>Fecha de Entrega *
                                </label>
                                <input type="date" name="fecha" class="form-control form-control-lg" required
                                       value="{{ nota.fecha if nota else today }}" min="{{ today }}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modalidad de pago -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-credit-card me-2"></i>Modalidad de Pago
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="form-check payment-option">
                                    <input class="form-check-input" type="radio" name="modalidad_pago" 
                                           id="contado" value="contado" required
                                           {% if not nota or nota.modalidad_pago == 'contado' %}checked{% endif %}>
                                    <label class="form-check-label w-100" for="contado">
                                        <div class="payment-card bg-success text-white p-3 rounded text-center">
                                            <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
                                            <h6 class="mb-1">Contado</h6>
                                            <small>Pago inmediato</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check payment-option">
                                    <input class="form-check-input" type="radio" name="modalidad_pago" 
                                           id="credito" value="credito"
                                           {% if nota and nota.modalidad_pago == 'credito' %}checked{% endif %}>
                                    <label class="form-check-label w-100" for="credito">
                                        <div class="payment-card bg-warning text-dark p-3 rounded text-center">
                                            <i class="fas fa-clock fa-2x mb-2"></i>
                                            <h6 class="mb-1">A Crédito</h6>
                                            <small>30 días para facturar</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check payment-option">
                                    <input class="form-check-input" type="radio" name="modalidad_pago" 
                                           id="nota_credito" value="nota_credito"
                                           {% if nota and nota.modalidad_pago == 'nota_credito' %}checked{% endif %}>
                                    <label class="form-check-label w-100" for="nota_credito">
                                        <div class="payment-card bg-info text-white p-3 rounded text-center">
                                            <i class="fas fa-sticky-note fa-2x mb-2"></i>
                                            <h6 class="mb-1">Nota de Crédito</h6>
                                            <small>Sin facturación</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información adicional según modalidad -->
                        <div id="infoModalidad" class="mt-3 p-3 rounded" style="display: none;">
                            <div id="infoContado" class="alert alert-success mb-0" style="display: none;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Contado:</strong> El cliente paga al momento de la entrega. No requiere facturación posterior.
                            </div>
                            <div id="infoCredito" class="alert alert-warning mb-0" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>A Crédito:</strong> Debes convertir esta nota a factura dentro de 30 días para cumplir con la normativa SENIAT.
                            </div>
                            <div id="infoNotaCredito" class="alert alert-info mb-0" style="display: none;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Nota de Crédito:</strong> Solo documento de entrega. Nunca se convierte a factura.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección de Productos -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-boxes me-2"></i>Productos a Entregar
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="productos-container">
                            <!-- Los productos se agregarán dinámicamente aquí -->
                        </div>
                        
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-success btn-lg" onclick="addProducto()">
                                <i class="fas fa-plus me-2"></i>Agregar Producto
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha - Resumen y configuración -->
            <div class="col-lg-4">
                <div class="card shadow-sm sticky-top" style="top: 20px;">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Resumen y Configuración</h5>
                    </div>
                    <div class="card-body">
                        <!-- Configuración de descuento e IVA -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3"><i class="fas fa-cog me-2"></i>Configuración</h6>
                            
                            <div class="mb-3">
                                <label for="porcentaje_descuento" class="form-label">
                                    <i class="fas fa-percentage me-1"></i>Porcentaje de Descuento
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="porcentaje_descuento" name="porcentaje_descuento" 
                                           min="0" max="100" step="0.01" value="0" 
                                           onchange="calcularTotales()">
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="text-muted">Deja en 0 si no hay descuento</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-info-circle me-1"></i>Información Importante
                                </label>
                                <div class="alert alert-info mb-0">
                                    <small>
                                        <strong>Nota de Entrega:</strong> Este documento no incluye IVA. 
                                        Solo se aplica descuento si es necesario. El IVA se calculará 
                                        cuando se convierta a factura.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumen de la nota -->
                        <div class="border-top pt-3">
                            <h6 class="text-muted mb-3"><i class="fas fa-chart-pie me-2"></i>Resumen</h6>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Total Productos:</span>
                                <span class="fw-bold" id="total-productos">0</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Total Items:</span>
                                <span class="fw-bold" id="total-items">0</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Subtotal USD:</span>
                                <span class="fw-bold text-primary" id="subtotal-usd">$0.00</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-2" id="descuento-row" style="display: none;">
                                <span class="text-muted">Descuento:</span>
                                <span class="fw-bold text-success" id="descuento-usd">-$0.00</span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-2" id="subtotal-con-descuento-row" style="display: none;">
                                <span class="text-muted">Subtotal con Descuento:</span>
                                <span class="fw-bold text-primary" id="subtotal-con-descuento">$0.00</span>
                            </div>
                            
                            <hr>
                            
                            <div class="d-flex justify-content-between mb-0">
                                <span class="h6 text-muted">TOTAL USD:</span>
                                <span class="h5 fw-bold text-danger" id="total-usd">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Campo oculto para el total -->
        <input type="hidden" name="total_oculto" id="total_oculto" value="0">
        
        <!-- Botones de acción -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-success btn-lg me-3">
                    <i class="fas fa-save me-2"></i>
                    {{ 'Actualizar' if nota else 'Crear' }} Nota de Entrega
                </button>
                
                {% if nota %}
                <a href="{{ url_for('imprimir_nota_entrega', id=nota.numero) }}" 
                   class="btn btn-outline-primary btn-lg me-3">
                    <i class="fas fa-print me-2"></i>Imprimir Nota
                </a>
                {% endif %}
                
                <a href="{{ url_for('mostrar_notas_entrega') }}" class="btn btn-outline-secondary btn-lg">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Estilos adicionales -->
<style>
.payment-option {
    margin: 0;
}

.payment-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 3px solid transparent;
}

.payment-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.form-check-input:checked + .form-check-label .payment-card {
    border-color: #fff;
    box-shadow: 0 0 0 3px rgba(255,255,255,0.5);
}

.producto-row {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.producto-row:hover {
    background: #e9ecef;
}

.btn-remove-producto:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.sticky-top {
    z-index: 1000;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: border-color 0.2s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.card {
    border-radius: 12px;
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
    border: none;
}
</style>

<!-- JavaScript para funcionalidad -->
<script>
    // Variables globales
    let productCounter = 0;
    
    // Inicializar cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        // Mostrar modalidad de pago por defecto
        mostrarModalidadPago('contado');
        
        // Verificar si estamos editando una nota existente
        if (typeof notaExiste !== 'undefined' && notaExiste) {
            // Cargar productos existentes
            cargarProductosExistentes();
        } else {
            // Agregar primer producto por defecto para nueva nota
            addProducto();
        }
        
        // Event listeners para modalidades de pago
        document.querySelectorAll('input[name="modalidad_pago"]').forEach(radio => {
            radio.addEventListener('change', function() {
                mostrarModalidadPago(this.value);
            });
        });
        
        // Validar formulario antes de enviar
        document.getElementById('notaForm').addEventListener('submit', function(e) {
            if (!validarFormulario()) {
                e.preventDefault();
            }
        });
    });
    
    // Función para mostrar información según modalidad de pago
    function mostrarModalidadPago(modalidad) {
        // Ocultar todas las alertas
        document.querySelectorAll('.alert').forEach(alert => alert.style.display = 'none');
        
        // Mostrar alerta correspondiente
        if (modalidad === 'contado') {
            document.getElementById('infoContado').style.display = 'block';
        } else if (modalidad === 'credito') {
            document.getElementById('infoCredito').style.display = 'block';
        } else if (modalidad === 'nota_credito') {
            document.getElementById('infoNotaCredito').style.display = 'block';
        }
        
        // Mostrar/ocultar días de crédito
        const diasCreditoDiv = document.getElementById('diasCreditoDiv');
        if (modalidad === 'credito') {
            diasCreditoDiv.style.display = 'block';
        } else {
            diasCreditoDiv.style.display = 'none';
        }
    }
    
    // Función para agregar producto
    function addProducto() {
        productCounter++;
        const container = document.getElementById('productos-container');
        
        const productoRow = document.createElement('div');
        productoRow.className = 'producto-row row g-3 mb-3';
        productoRow.innerHTML = `
            <div class="col-md-4">
                <label class="form-label fw-bold">Producto *</label>
                <select name="productos[]" class="form-select producto-select" required onchange="autoCompletarPrecio(this)">
                    <option value="">Seleccionar producto...</option>
                    {% for producto_id, producto in inventario.items() %}
                    <option value="{{ producto_id }}" 
                            data-precio="{{ producto.precio_usd }}"
                            data-stock="{{ producto.stock }}">
                        {{ producto.nombre }} (Stock: {{ producto.stock }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">Cantidad *</label>
                <input type="number" name="cantidades[]" class="form-control cantidad-input" 
                       min="1" required placeholder="Cant." onchange="calcularSubtotal(this)">
                <small class="stock-info text-muted" style="display: none;"></small>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">Precio USD *</label>
                <input type="number" name="precios[]" class="form-control precio-input" 
                       step="0.01" min="0" required placeholder="0.00" onchange="calcularSubtotal(this)">
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">Subtotal</label>
                <input type="text" class="form-control subtotal-display" readonly 
                       placeholder="$0.00">
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-remove-producto" 
                        onclick="removeProducto(this)" ${productCounter === 1 ? 'disabled' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(productoRow);
        
        // Habilitar botón de eliminar si hay más de un producto
        if (productCounter > 1) {
            document.querySelectorAll('.btn-remove-producto').forEach(btn => {
                btn.disabled = false;
            });
        }
    }
    
    // Función para cargar productos existentes al editar
    function cargarProductosExistentes() {
        // Esta función se implementará después
    }
    
    // Función para eliminar producto
    function removeProducto(button) {
        const productoRow = button.closest('.producto-row');
        productoRow.remove();
        productCounter--;
        
        // Deshabilitar botón de eliminar si solo queda un producto
        if (productCounter === 1) {
            document.querySelectorAll('.btn-remove-producto').forEach(btn => {
                btn.disabled = true;
            });
        }
        
        calcularTotales();
    }
    
    // Función para auto-completar precio
    function autoCompletarPrecio(select) {
        const row = select.closest('.producto-row');
        const precioInput = row.querySelector('.precio-input');
        const cantidadInput = row.querySelector('.cantidad-input');
        const option = select.options[select.selectedIndex];
        
        if (option.value && option.dataset.precio) {
            // Llenar precio automáticamente desde el inventario
            precioInput.value = option.dataset.precio;
            
            // Mostrar stock disponible
            const stock = parseInt(option.dataset.stock) || 0;
            const stockInfo = row.querySelector('.stock-info');
            
            if (stock > 0) {
                cantidadInput.max = stock;
                cantidadInput.placeholder = `Máx: ${stock}`;
                stockInfo.textContent = `Stock disponible: ${stock} unidades`;
                stockInfo.style.display = 'block';
                
                // Agregar tooltip o alerta de stock
                if (stock < 10) {
                    cantidadInput.style.borderColor = '#e74c3c';
                    cantidadInput.title = `⚠️ Stock bajo: ${stock} unidades disponibles`;
                    stockInfo.style.color = '#e74c3c';
                    stockInfo.innerHTML = `⚠️ Stock bajo: <strong>${stock}</strong> unidades`;
                } else {
                    cantidadInput.style.borderColor = '';
                    cantidadInput.title = `${stock} unidades disponibles`;
                    stockInfo.style.color = '#6c757d';
                    stockInfo.innerHTML = `Stock disponible: <strong>${stock}</strong> unidades`;
                }
            } else {
                cantidadInput.max = 0;
                cantidadInput.placeholder = 'Sin stock';
                cantidadInput.style.borderColor = '#e74c3c';
                cantidadInput.title = '❌ Producto sin stock disponible';
                stockInfo.textContent = '❌ Sin stock disponible';
                stockInfo.style.color = '#e74c3c';
                stockInfo.style.display = 'block';
            }
            
            calcularSubtotal(precioInput);
        }
    }
    
    // Función para calcular subtotal de un producto
    function calcularSubtotal(input) {
        const row = input.closest('.producto-row');
        const cantidad = parseInt(row.querySelector('.cantidad-input').value) || 0;
        const precio = parseFloat(row.querySelector('.precio-input').value) || 0;
        const subtotalDisplay = row.querySelector('.subtotal-display');
        
        const subtotal = cantidad * precio;
        subtotalDisplay.value = `$${subtotal.toFixed(2)}`;
        
        calcularTotales();
    }
    
    // Función para calcular totales
    function calcularTotales() {
        let subtotal = 0;
        let totalProductos = 0;
        let totalItems = 0;
        
        // Calcular subtotal y contar productos
        document.querySelectorAll('.producto-row').forEach(row => {
            const cantidad = parseInt(row.querySelector('.cantidad-input').value) || 0;
            const precio = parseFloat(row.querySelector('.precio-input').value) || 0;
            
            if (cantidad > 0 && precio > 0) {
                subtotal += cantidad * precio;
                totalProductos++;
                totalItems += cantidad;
            }
        });
        
        // Obtener porcentaje de descuento
        const porcentajeDescuento = parseFloat(document.getElementById('porcentaje_descuento').value) || 0;
        
        // Calcular descuento
        const descuento = subtotal * (porcentajeDescuento / 100);
        const total = subtotal - descuento;
        
        // Actualizar resumen
        document.getElementById('total-productos').textContent = totalProductos;
        document.getElementById('total-items').textContent = totalItems;
        document.getElementById('subtotal-usd').textContent = `$${subtotal.toFixed(2)}`;
        
        // Mostrar/ocultar descuento
        const descuentoRow = document.getElementById('descuento-row');
        const descuentoUsdSpan = document.getElementById('descuento-usd');
        const subtotalConDescuentoRow = document.getElementById('subtotal-con-descuento-row');
        const subtotalConDescuentoSpan = document.getElementById('subtotal-con-descuento');
        
        if (porcentajeDescuento > 0) {
            descuentoUsdSpan.textContent = `-$${descuento.toFixed(2)}`;
            descuentoRow.style.display = 'flex';
            subtotalConDescuentoSpan.textContent = `$${(subtotal - descuento).toFixed(2)}`;
            subtotalConDescuentoRow.style.display = 'flex';
        } else {
            descuentoRow.style.display = 'none';
            subtotalConDescuentoRow.style.display = 'none';
        }
        
        document.getElementById('total-usd').textContent = `$${total.toFixed(2)}`;
        
        // Actualizar campo oculto del total
        document.getElementById('total_oculto').value = total.toFixed(2);
    }
    
    // Validación del formulario
    function validarFormulario() {
        const productos = document.querySelectorAll('.producto-row');
        let valido = true;
        let mensajeError = '';
        
        productos.forEach(row => {
            const producto = row.querySelector('.producto-select').value;
            const cantidad = parseInt(row.querySelector('.cantidad-input').value) || 0;
            const precio = row.querySelector('.precio-input').value;
            const stock = parseInt(row.querySelector('.cantidad-input').max) || 0;
            
            if (!producto || !cantidad || !precio) {
                valido = false;
                row.style.border = '2px solid #e74c3c';
                mensajeError = 'Por favor, complete todos los campos obligatorios de productos.';
            } else if (cantidad > stock) {
                valido = false;
                row.style.border = '2px solid #e74c3c';
                mensajeError = `La cantidad solicitada (${cantidad}) excede el stock disponible (${stock}).`;
            } else if (cantidad <= 0) {
                valido = false;
                row.style.border = '2px solid #e74c3c';
                mensajeError = 'La cantidad debe ser mayor a 0.';
            } else {
                row.style.border = '';
            }
        });
        
        if (!valido) {
            alert(mensajeError);
            return false;
        }
        
        return true;
    }
    

</script>

<!-- Script para cargar productos existentes al editar -->
{% if nota and nota.productos %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Esperar un momento para que se cargue todo
    setTimeout(function() {
        const productos = {{ nota.productos|tojson }};
        const cantidades = {{ nota.cantidades|tojson }};
        const precios = {{ nota.precios|tojson }};
        
        // Limpiar contenedor de productos
        document.getElementById('productos-container').innerHTML = '';
        productCounter = 0;
        
        // Agregar cada producto existente
        for (let i = 0; i < productos.length; i++) {
            addProducto();
            
            // Obtener la fila recién creada
            const productoRow = document.querySelector('.producto-row:last-child');
            
            // Seleccionar el producto
            const productoSelect = productoRow.querySelector('select[name="productos[]"]');
            productoSelect.value = productos[i];
            
            // Establecer cantidad
            const cantidadInput = productoRow.querySelector('input[name="cantidades[]"]');
            cantidadInput.value = cantidades[i];
            
            // Establecer precio
            const precioInput = productoRow.querySelector('input[name="precios[]"]');
            precioInput.value = precios[i];
            
            // Calcular subtotal
            calcularSubtotal(precioInput);
        }
        
        // Actualizar totales
        calcularTotales();
    }, 100);
});
</script>
{% endif %}

{% endblock %}
